<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前言 | 龙台技术笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/images/book.png">
    <link rel="manifest" href="/images/book.png">
    <link rel="apple-touch-icon" href="/images/book.png">
    <meta name="description" content="技术人写的技术笔记（工作总结）">
    <meta http-quiv="pragma" cotent="no-cache">
    <meta http-quiv="pragma" cotent="no-cache,must-revalidate">
    <meta http-quiv="expires" cotent="0">
    
    <link rel="preload" href="/assets/css/0.styles.56f8f03c.css" as="style"><link rel="preload" href="/assets/js/app.9f6db045.js" as="script"><link rel="preload" href="/assets/js/2.ad010850.js" as="script"><link rel="preload" href="/assets/js/28.b05c6b48.js" as="script"><link rel="prefetch" href="/assets/js/10.cbffc92a.js"><link rel="prefetch" href="/assets/js/11.05ca654e.js"><link rel="prefetch" href="/assets/js/12.ad56d1ad.js"><link rel="prefetch" href="/assets/js/13.cbb68b5f.js"><link rel="prefetch" href="/assets/js/14.deb3efeb.js"><link rel="prefetch" href="/assets/js/15.4bd8d806.js"><link rel="prefetch" href="/assets/js/16.18544ac8.js"><link rel="prefetch" href="/assets/js/17.3d970734.js"><link rel="prefetch" href="/assets/js/18.24bdf351.js"><link rel="prefetch" href="/assets/js/19.20ee8468.js"><link rel="prefetch" href="/assets/js/20.76cc2f2f.js"><link rel="prefetch" href="/assets/js/21.a060d59a.js"><link rel="prefetch" href="/assets/js/22.8dd2c3cb.js"><link rel="prefetch" href="/assets/js/23.38503d1a.js"><link rel="prefetch" href="/assets/js/24.b5bab63e.js"><link rel="prefetch" href="/assets/js/25.f541c5de.js"><link rel="prefetch" href="/assets/js/26.ee0820ec.js"><link rel="prefetch" href="/assets/js/27.8e2f5fd3.js"><link rel="prefetch" href="/assets/js/29.19cdc57c.js"><link rel="prefetch" href="/assets/js/3.d533eea8.js"><link rel="prefetch" href="/assets/js/30.98878ec6.js"><link rel="prefetch" href="/assets/js/31.572b5ab4.js"><link rel="prefetch" href="/assets/js/32.bce65027.js"><link rel="prefetch" href="/assets/js/33.37e89393.js"><link rel="prefetch" href="/assets/js/34.ba1a6fba.js"><link rel="prefetch" href="/assets/js/35.c7dd14b8.js"><link rel="prefetch" href="/assets/js/36.91b56d4a.js"><link rel="prefetch" href="/assets/js/37.818f9351.js"><link rel="prefetch" href="/assets/js/38.f7f3e6b0.js"><link rel="prefetch" href="/assets/js/39.4a1489dc.js"><link rel="prefetch" href="/assets/js/4.d52d5841.js"><link rel="prefetch" href="/assets/js/40.175dfc07.js"><link rel="prefetch" href="/assets/js/41.d75e30b9.js"><link rel="prefetch" href="/assets/js/42.dcfe80e6.js"><link rel="prefetch" href="/assets/js/43.4669e03d.js"><link rel="prefetch" href="/assets/js/44.5b6aa46b.js"><link rel="prefetch" href="/assets/js/5.8c9ed1e9.js"><link rel="prefetch" href="/assets/js/6.256d2fbb.js"><link rel="prefetch" href="/assets/js/7.26cc56f0.js"><link rel="prefetch" href="/assets/js/8.d0a0d91a.js"><link rel="prefetch" href="/assets/js/9.272d66c4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.56f8f03c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">龙台技术笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/db/" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/thread/" class="nav-link">
  并发编程
</a></div><div class="nav-item"><a href="/frame/" class="nav-link router-link-active">
  框架知识
</a></div><div class="nav-item"><a href="/design/" class="nav-link">
  代码设计
</a></div><div class="nav-item"><a href="/bug/" class="nav-link">
  BUG 专栏
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title">其它</span> <span class="arrow down"></span></button> <button type="button" aria-label="其它" class="mobile-dropdown-title"><span class="title">其它</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  动态线程池
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/acmenlt/House-Notes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  买房实践
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/db/" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/thread/" class="nav-link">
  并发编程
</a></div><div class="nav-item"><a href="/frame/" class="nav-link router-link-active">
  框架知识
</a></div><div class="nav-item"><a href="/design/" class="nav-link">
  代码设计
</a></div><div class="nav-item"><a href="/bug/" class="nav-link">
  BUG 专栏
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title">其它</span> <span class="arrow down"></span></button> <button type="button" aria-label="其它" class="mobile-dropdown-title"><span class="title">其它</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  动态线程池
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/acmenlt/House-Notes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  买房实践
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前言</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%8E%9F%E7%90%86.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%8E%9F%E7%90%86.html#概念小贴士" class="sidebar-link">概念小贴士</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%8E%9F%E7%90%86.html#负载均衡" class="sidebar-link">负载均衡</a></li><li class="sidebar-sub-header"><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%8E%9F%E7%90%86.html#ribbon" class="sidebar-link">Ribbon</a></li></ul></li><li><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%8E%9F%E7%90%86.html#环境准备" class="sidebar-link">环境准备</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%8E%9F%E7%90%86.html#如何获取注册中心服务实例" class="sidebar-link">如何获取注册中心服务实例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%8E%9F%E7%90%86.html#getloadbalancer" class="sidebar-link">getLoadBalancer</a></li><li class="sidebar-sub-header"><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%8E%9F%E7%90%86.html#zoneawareloadbalancer" class="sidebar-link">ZoneAwareLoadBalancer</a></li><li class="sidebar-sub-header"><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%8E%9F%E7%90%86.html#iping-服务探测" class="sidebar-link">IPing 服务探测</a></li><li class="sidebar-sub-header"><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%8E%9F%E7%90%86.html#irule-负载均衡" class="sidebar-link">IRule 负载均衡</a></li></ul></li><li><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%8E%9F%E7%90%86.html#非健康服务实例如何下线" class="sidebar-link">非健康服务实例如何下线</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%8E%9F%E7%90%86.html#服务列表定时维护" class="sidebar-link">服务列表定时维护</a></li></ul></li><li><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%8E%9F%E7%90%86.html#ribbon-底层原理实现" class="sidebar-link">Ribbon 底层原理实现</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%8E%9F%E7%90%86.html#自定义-ribbon-负载均衡策略" class="sidebar-link">自定义 Ribbon 负载均衡策略</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%8E%9F%E7%90%86.html#关于-iping-的思考" class="sidebar-link">关于 IPing 的思考</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%8E%9F%E7%90%86.html#结言" class="sidebar-link">结言</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>继 SpringCloud Feign 之后的第二篇分布式框架文章，同样秉承单周末一个 SpringCloud 组件的大目标为原则</p> <p>如果想看 Feign 的小伙伴，<a href="https://mp.weixin.qq.com/s/zYfhJDyHji58Skw3IqIWzg" target="_blank" rel="noopener noreferrer">猛戳这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，Feign 核心原理与你不期而遇</p> <p>在平常使用 SpringCloud 中，一般会使用 Feign，因为 Feign 内部集成了 Ribbon</p> <p>但是 Ribbon 又是一个不可忽视的知识点，并且比 Feign 要难很多。列举文章大纲主题</p> <blockquote><ol><li>如何获取注册中心服务实例</li> <li>非健康服务实例如何下线</li> <li>Ribbon 底层原理实现</li> <li>自定义 Ribbon 负载均衡策略</li></ol></blockquote> <p>文章使用 SpringCloud Ribbon 源代码 Hoxton.SR9 版本：<strong>2.2.6.RELEASE</strong></p> <p><em>另外在文章结尾，说了一些看源码过程中的感想，以及 Ribbon 中笔者实现不合理的流程说明</em></p> <h2 id="概念小贴士"><a href="#概念小贴士" class="header-anchor">#</a> 概念小贴士</h2> <h3 id="负载均衡"><a href="#负载均衡" class="header-anchor">#</a> 负载均衡</h3> <p>负载均衡是指通过负载均衡策略分配到多个执行单元上，常见的负载均衡方式有两种</p> <ul><li>独立进程单元，通过负载均衡策略，将请求进行分发到不同执行上，类似于 Nginx</li> <li>客户端行为，将负载均衡的策略绑定到客户端上，客户端会维护一份服务提供者列表，通过客户端负载均衡策略分发到不同的服务提供者</li></ul> <h3 id="ribbon"><a href="#ribbon" class="header-anchor">#</a> Ribbon</h3> <p>Ribbon 是 Netflix 公司开源的一款负载均衡组件，负载均衡的行为在客户端发生，所以属于上述第二种</p> <p>一般而言，SpringCloud 构建以及使用时，会使用 Ribbon 作为客户端负载均衡工具。但是不会独立使用，而是结合 RestTemplate 以及 Feign 使用，Feign 底层集成了 Ribbon，不用额外的配置，开箱即用</p> <p>文章为了更贴切 Ribbon 主题，所以使用 RestTemplate 充当网络调用工具</p> <p>RestTemplate 是 Spring Web 下提供访问第三方 RESTFul Http 接口的网络框架</p> <h2 id="环境准备"><a href="#环境准备" class="header-anchor">#</a> 环境准备</h2> <p>注册中心选用阿里 Nacos，创建两个服务，生产者集群启动，消费者使用 RestTemplate + Ribbon 调用，调用总体结构如下</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210122182633581.png" alt=""></p> <p>生产者代码如下，将服务注册 Nacos，并对外暴露 Http Get 服务</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210123112352094.png" alt=""></p> <p>消费者代码如下，将服务注册 Nacos，通过 RestTemplate + Ribbon 发起远程负载均衡调用</p> <p>RestTemplate 默认是没有负载均衡的，所以需要添加 @LoadBalanced</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210123112532490.png" alt=""></p> <p>启动三个生产者实例注册 Nacos，启动并且注册成功如下所示</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210123123103613.png" alt=""></p> <p>想要按严格的先后顺序介绍框架原理，而不超前引用尚未介绍过的术语，<strong>这几乎是不可能的</strong>，笔者尽可能介绍明白</p> <h2 id="如何获取注册中心服务实例"><a href="#如何获取注册中心服务实例" class="header-anchor">#</a> 如何获取注册中心服务实例</h2> <p>先来看一下 Ribbon 是如何在客户端获取到注册中心运行实例的，这个点在之前是我比较疑惑的内容</p> <blockquote><p>服务注册相关的知识点，会放到 Nacos 源码解析说明</p></blockquote> <p>先来举个例子，当我们执行一个请求时，肯定要进行负载均衡对吧，这个时候代码跟到负载均衡获取服务列表源码的地方</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210124134853454.png" alt=""></p> <p>解释一下上面标黄色框框的地方：</p> <ul><li>RibbonLoadBalancerClient：负责负载均衡的请求处理</li> <li>ILoadBalancer：接口中定义了一系列实现负载均衡的方法，相当于一个路由的作用，Ribbon 中默认实现类 ZoneAwareLoadBalancer</li> <li>unknown：ZoneAwareLoadBalancer 是多区域负载均衡器，这个 unkonwn 代表默认区域的意思</li> <li>allServerList：代表了从 Nacos 注册中心获取的接口服务实例，upServerList 代表了健康实例</li></ul> <p>现在想要知道 Ribbon 是如何获取服务实例的就需要跟进 <strong>getLoadBalancer()</strong></p> <h3 id="getloadbalancer"><a href="#getloadbalancer" class="header-anchor">#</a> getLoadBalancer</h3> <p>首先声明一点，getLoadBalancer() 方法的语意是从 Ribbon 父子上下文容器中获取名称为 <strong>ribbon-produce</strong>，类型为 <strong>ILoadBalancer.class</strong> 的 Spring Bean</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210124141655558.png" alt=""></p> <p>之前在讲 Feign 的时候说过，Ribbon 会为每一个服务提供者创建一个 Spring 父子上下文，这里会从子上下文中获取 Bean</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210124142007712.png" alt=""></p> <p>看到这里并没有解决我们的疑惑，以为方法里会有拉取服务列表的代码，然鹅只是返回一个包含了服务实例的 Bean，所以我们只能去跟下这个 Bean 的上下文</p> <p>我们需要从负载均衡客户端着手，因为默认是 ZoneAwareLoadBalancer，那我们需要跟进它何时被创建，初始化都做了什么事情</p> <h3 id="zoneawareloadbalancer"><a href="#zoneawareloadbalancer" class="header-anchor">#</a> ZoneAwareLoadBalancer</h3> <p>ZoneAwareLoadBalancer 是一个根据区域（Zone）来进行负载均衡器，因为如果不同机房跨区域部署服务列表，跨区域的方式访问会产生更高的延迟，ZoneAwareLoadBalancer 就是为了解决此类问题，不过默认都是同一区域</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210124171342217.png" alt=""></p> <p>ZoneAwareLoadBalancer 很重要，或者说它代表的 <strong>负载均衡路由角色</strong> 很重要。进行服务调用前，会使用该类根据负载均衡算法获取可用 Server 进行远程调用，所以我们要掌握创建这个负载均衡客户端时都做了哪些</p> <p>ZoneAwareLoadBalancer 是在服务第一次被调用时通过子容器创建</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span> <span class="token annotation punctuation">@ConditionalOnMissingBean</span>  <span class="token comment">// RibbonClientConfiguration 被加载，从 IOC 容器中获取对应实例填充到 ZoneAwareLoadBalancer</span>
<span class="token keyword">public</span> <span class="token class-name">ILoadBalancer</span> <span class="token function">ribbonLoadBalancer</span><span class="token punctuation">(</span><span class="token class-name">IClientConfig</span> config<span class="token punctuation">,</span>
                                        <span class="token class-name">ServerList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> serverList<span class="token punctuation">,</span> <span class="token class-name">ServerListFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> serverListFilter<span class="token punctuation">,</span>
                                        <span class="token class-name">IRule</span> rule<span class="token punctuation">,</span> <span class="token class-name">IPing</span> ping<span class="token punctuation">,</span> <span class="token class-name">ServerListUpdater</span> serverListUpdater<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ZoneAwareLoadBalancer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> rule<span class="token punctuation">,</span> ping<span class="token punctuation">,</span> serverList<span class="token punctuation">,</span>
            serverListFilter<span class="token punctuation">,</span> serverListUpdater<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">ZoneAwareLoadBalancer</span><span class="token punctuation">(</span><span class="token class-name">IClientConfig</span> clientConfig<span class="token punctuation">,</span> <span class="token class-name">IRule</span> rule<span class="token punctuation">,</span>
                             <span class="token class-name">IPing</span> ping<span class="token punctuation">,</span> <span class="token class-name">ServerList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> serverList<span class="token punctuation">,</span> <span class="token class-name">ServerListFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> filter<span class="token punctuation">,</span>
                             <span class="token class-name">ServerListUpdater</span> serverListUpdater<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用父类构造方法</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">,</span> rule<span class="token punctuation">,</span> ping<span class="token punctuation">,</span> serverList<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> serverListUpdater<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>在 DynamicServerListLoadBalancer 中调用了父类 BaseLoadBalancer 初始化了一部分配置以及方法，另外自己也初始化了 Server 服务列表等元数据</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">DynamicServerListLoadBalancer</span><span class="token punctuation">(</span><span class="token class-name">IClientConfig</span> clientConfig<span class="token punctuation">,</span> <span class="token class-name">IRule</span> rule<span class="token punctuation">,</span> <span class="token class-name">IPing</span> ping<span class="token punctuation">,</span>
                                     <span class="token class-name">ServerList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> serverList<span class="token punctuation">,</span> <span class="token class-name">ServerListFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> filter<span class="token punctuation">,</span>
                                     <span class="token class-name">ServerListUpdater</span> serverListUpdater<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用父类 BaseLoadBalancer 初始化一些配置，包括 Ping（检查服务是否可用）Rule（负载均衡规则）</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">,</span> rule<span class="token punctuation">,</span> ping<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 较重要，获取注册中心服务的接口</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>serverListImpl <span class="token operator">=</span> serverList<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>filter <span class="token operator">=</span> filter<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>serverListUpdater <span class="token operator">=</span> serverListUpdater<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>filter <span class="token keyword">instanceof</span> <span class="token class-name">AbstractServerListFilter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractServerListFilter</span><span class="token punctuation">)</span> filter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLoadBalancerStats</span><span class="token punctuation">(</span><span class="token function">getLoadBalancerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 初始化步骤分了两步走，第一步在上面，这一步就是其余的初始化</span>
    <span class="token function">restOfInit</span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>先来说一下 BaseLoadBalancer 中初始化的方法，这里主要对一些重要参数以及 Ping、Rule 赋值，另外根据 IPing 实现类执行定时器，下面介绍 Ping 和 Rule 是什么</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210124173636638.png" alt=""></p> <p>方法大致做了以下几件事情：</p> <ol><li>设置客户端配置对象、名称等关键参数</li> <li>获取每次 Ping 的间隔以及 Ping 的最大时间</li> <li>设置具体负载均衡规则 IRule，默认 ZoneAvoidanceRule，根据 server 和 zone 区域来轮询</li> <li>设置具体 Ping 的方式，默认 DummyPing，直接返回 True</li> <li>根据 Ping 的具体实现，执行定时任务 Ping Server</li></ol> <p>这里会介绍被填入的 IPing 和 IRule 是什么东东，并且都有哪些实现</p> <h3 id="iping-服务探测"><a href="#iping-服务探测" class="header-anchor">#</a> IPing 服务探测</h3> <p>IPing 接口负责向 Server 实例发送 ping 请求，判断 Server 是否有响应，以此来判断 Server 是否可用</p> <p>接口只有一个方法 isAlive，通过实现类完成探测 ping 功能</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IPing</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token class-name">Server</span> server<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>IPing 实现类如下：</p> <ul><li>PingUrl：通过 ping 的方式，发起网络调用来判断 Server 是否可用（一般而言创建 PingUrl 需要指定路径，默认是 IP + Port）</li> <li>PingConstant：固定返回某服务是否可用，默认返回 True，表示可用</li> <li>NoOpPing：没有任何操作，直接返回 True，表示可用</li> <li>DummyPing：默认的类，直接返回 True，实现了 initWithNiwsConfig 方法</li></ul> <h3 id="irule-负载均衡"><a href="#irule-负载均衡" class="header-anchor">#</a> IRule 负载均衡</h3> <p>IRule 接口负责根据不用的算法和逻辑处理负载均衡的策略，自带的策略有 7 种，默认 ZoneAvoidanceRule</p> <ol><li>BestAvailableRule：选择服务列表中最小请求量的 Server</li> <li>RandomRule：服务列表中随机选择 Server</li> <li>RetryRule：根据轮询的方式重试 Server</li> <li>ZoneAvoidanceRule：根据 Server 的 Zone 区域和可用性轮询选择 Server</li> <li>...</li></ol> <p>上面说过，会有两个初始化步骤，刚才只说了一个，接下来说一下 这个其余初始化方法 <code>restOfInit</code>，虽然取名叫其余初始化，但是就重要性而言，那是相当重要</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">restOfInit</span><span class="token punctuation">(</span><span class="token class-name">IClientConfig</span> clientConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> primeConnection <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isEnablePrimingConnections</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// turn this off to avoid duplicated asynchronous priming done in BaseLoadBalancer.setServerList()</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setEnablePrimingConnections</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始化服务列表，并启用定时器，对服务列表作出更新</span>
    <span class="token function">enableAndInitLearnNewServersFeature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 更新服务列表，enableAndInitLearnNewServersFeature 中定时器的执行的就是此方法</span>
    <span class="token function">updateListOfServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>primeConnection <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPrimeConnections</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPrimeConnections</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">primeConnections</span><span class="token punctuation">(</span><span class="token function">getReachableServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setEnablePrimingConnections</span><span class="token punctuation">(</span>primeConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    LOGGER<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;DynamicServerListLoadBalancer for client {} initialized: {}&quot;</span><span class="token punctuation">,</span> clientConfig<span class="token punctuation">.</span><span class="token function">getClientName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>获取服务列表以及定时更新服务列表的代码都在此处，值得仔细看着源码。关注其中更新服务列表方法就阔以了</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateListOfServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> servers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>serverListImpl <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取服务列表数据</span>
        servers <span class="token operator">=</span> serverListImpl<span class="token punctuation">.</span><span class="token function">getUpdatedListOfServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        LOGGER<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;List of Servers for {} obtained from Discovery client: {}&quot;</span><span class="token punctuation">,</span>
                <span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> servers<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>filter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            servers <span class="token operator">=</span> filter<span class="token punctuation">.</span><span class="token function">getFilteredListOfServers</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span><span class="token punctuation">;</span>
            LOGGER<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Filtered List of Servers for {} obtained from Discovery client: {}&quot;</span><span class="token punctuation">,</span>
                    <span class="token function">getIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> servers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 更新所有服务列表</span>
    <span class="token function">updateAllServerList</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>第一个问题兜兜转转，终于要找到如何获取的服务列表了，<strong>serverListImpl 实现自 ServerList</strong>，因为我们使用的 Nacos 注册中心，所以 ServerList 的具体实现就是 <strong>NacosServerList</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ServerList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getInitialListOfServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUpdatedListOfServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>ServerList 中只有两个接口方法，分别是 <strong>获取初始化服务列表集合、获取更新的服务列表集合</strong>，Nacos 实现中两个调用都是一个实现方法，可能设计如此</p> <p>相当于 Ribbon 提供出接口 ServerList，注册中心开发者们谁想和 Ribbon 集成，那你就实现这个接口吧，到时候 Ribbon 负责调用 ServerList 实现类中的方法实现</p> <blockquote><p>Ribbon 和各服务注册中心之间，这种实现方式和 JDBC 与各数据库之间很像</p></blockquote> <p>兜兜转转中问题已经明朗，一起总结下注册中心获取服务实例这块内容</p> <ol><li>负载均衡客户端在初始化时向 <strong>Nacos 注册中心获取服务注册列表信息</strong></li> <li>根据不同的 IPing 实现，向获取到的服务列表 <strong>串行发送 ping</strong>，以此来判断服务的可用性。没错，就是串行，如果你的实例很多，可以 <strong>考虑重写 ping 这一块的逻辑</strong></li> <li>如果服务的可用性 <strong>发生了改变或者被人为下线</strong>，那么重新拉取或更新服务列表</li> <li>当负载均衡客户端有了这些服务注册类列表，自然就可以进行 <strong>IRule 负载均衡策略</strong></li></ol> <h2 id="非健康服务实例如何下线"><a href="#非健康服务实例如何下线" class="header-anchor">#</a> 非健康服务实例如何下线</h2> <p>首先笔者做了两个 <strong>&quot;大胆&quot; 的实验</strong>，第一次是对生产者 SpringBoot 项目执行关闭流程，这时候 Nacos 注册中心是 <strong>实时感知到并将此服务下该实例删除</strong></p> <p>证明 Nacos 客户端是有 <strong>类似于钩子函数的存在</strong>，感知项目停止就会向 Nacos 服务端注销实例。但是这个时候要考虑一件事情，那就是在 <strong>暴力 Kill 或者执行关闭操作</strong> 的情况下，<strong>存在于 Ribbon 客户端服务列表缓存能不能感知</strong></p> <p>第二次我这边测试流程是这样的，可以极大程度还原生产上使用 Ribbon 可能会遇到的问题</p> <ol><li>改变客户端负载均衡策略为 <strong>随机负载 RandomRule</strong>，大家自己可以进行测试，不固定负载规则</li> <li>注册三个生产者服务实例到 Nacos 上，检查 <strong>确保服务组下实例正常注册</strong></li> <li>操作重点来了，先通过消费方实例请求下对应的生产者接口，保证 <strong>Ribbon 将对应 Server 缓存到客户端</strong></li> <li>停掉一个生产者服务，此时 <strong>马上使用 Jmeter 调用</strong>，Jmeter 线程组发起请求 100 次（一定要赶到更新 Server 缓存之前发起 Jmeter 请求）</li> <li>这时就会看到会发生随机失败，也就是说停掉一个服务后，<strong>最坏结果会有 30 秒的生产服务不可用</strong>，这个时间可配置，后面会讲到为什么 30 秒</li></ol> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210125103040301.png" alt=""></p> <h3 id="服务列表定时维护"><a href="#服务列表定时维护" class="header-anchor">#</a> 服务列表定时维护</h3> <p>针对于服务列表的维护，在 Ribbon 中有两种方式，都是通过定时任务的形式维护客户端列表缓存</p> <ol><li>使用 IPing 的实现类 PingUrl，<strong>每隔 10 秒会去 Ping 服务地址</strong>，如果返回状态不是 200，那么默认该实例下线</li> <li>Ribbon 客户端内置的扫描，<strong>默认每隔 30 秒去拉取 Nacos 也就是注册中心的服务实例</strong>，如果已下线实例会在客户端缓存中剔除</li></ol> <p>这一块源码都不贴了，放两个源代码位置，感兴趣自己看看就行了</p> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> DynamicServerListLoadBalancer#enableAndInitLearnNewServersFeature
</span><span class="token prefix inserted">+</span><span class="token line"> BaseLoadBalancer#setupPingTask
</span></span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>如果你面试的时候，面试官问了本小节相关内容，把这两个点都能答出来，基本上 SpringCloud 源码就差不多了</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210125180520015.png" alt=""></p> <h2 id="ribbon-底层原理实现"><a href="#ribbon-底层原理实现" class="header-anchor">#</a> Ribbon 底层原理实现</h2> <p>底层原理实现这一块内容，会先说明使用 Ribbon <strong>负载均衡调用远端请求的全过程</strong>，然后着重看一下 RandomRule <strong>负载策略底层是如何实现</strong></p> <ol><li>创建 ILoadBalancer 负载均衡客户端，初始化 Ribbon 中所需的 <strong>定时器和注册中心上服务实例列表</strong></li> <li>从 ILoadBalancer 中，通过 <strong>负载均衡选择出健康服务列表中的一个 Server</strong></li> <li><strong>将服务名（ribbon-produce）替换为 Server 中的 IP + Port</strong>，然后生成 HTTP 请求进行调用并返回数据</li></ol> <p>上面已经说过，ILoadBalancer 是负责负载均衡路由的，内部会使用 IRule 实现类进行负载调用</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ILoadBalancer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">chooseServer</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>chooseServer 流程中调用的就是 IRule 负载策略中的 choose 方法，在方法内部获取一个健康 Server</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token class-name">Server</span> server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> upList <span class="token operator">=</span> lb<span class="token punctuation">.</span><span class="token function">getReachableServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 获取服务列表健康实例        List&lt;Server&gt; allList = lb.getAllServers();  // 获取服务列表全部实例        int serverCount = allList.size();  // 全部实例数量        if (serverCount == 0) {  // 全部实例数量为空，返回 null，相当于错误返回            return null;        }        int index = chooseRandomInt(serverCount);  // 考虑到效率问题，使用多线程 ThreadLocalRandom 获取随机数        server = upList.get(index);  // 获取健康实例        if (server == null) {            // 作者认为出现获取 server 为空，证明服务列表正在调整，但是！这只是暂时的，所以当前释放出了 CPU            Thread.yield();            continue;        }        if (server.isAlive()) {  // 服务为健康，返回            return (server);        }        ...    }    return server;}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>简单说一下随机策略 choose 中流程</p> <ol><li>获取到全部服务、健康服务列表，<strong>判断全部实例数量是否等于 0</strong>，是则返回 null，相当于发生了错误</li> <li>从全部服务列表里获取下标索引，然后去 <strong>健康实例列表获取 Server</strong></li> <li>如果获取到的 Server 为空会放弃 CPU，然后再来一遍上面的流程，<strong>相当于一种重试机制</strong></li> <li>如果获取到的 Server 不健康，设置 Server 等于空，再歇一会，继续走一遍上面的流程</li></ol> <p>比较简单，有小伙伴可能就问了，如果健康实例小于全部实例怎么办？这种情况下存在两种可能</p> <ol><li>运气比较好，从全部实例数量中随机了比较小的数，刚好健康实例列表有这个数，那么返回 Server</li> <li>运气比较背，从全部实例数量中随机了某个数，健康实例列表数量为空或者小于这个数，直接会下标越界异常</li></ol> <p>留下一个思考题：</p> <p><strong>为什么不直接从健康实例中选择实例呢</strong></p> <p>如果直接从健康实例列表选择，就能规避下标越界异常，为什么作者要先从全部实例中获取 Server 下标？</p> <h2 id="自定义-ribbon-负载均衡策略"><a href="#自定义-ribbon-负载均衡策略" class="header-anchor">#</a> 自定义 Ribbon 负载均衡策略</h2> <p>这种自定义策略，在框架中都支持的比较友好，根据上面提的问题，我们自定义一款策略</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4jpublic</span> <span class="token keyword">class</span> <span class="token class-name">MyRule</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLoadBalancerRule</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">ILoadBalancer</span> loadBalancer <span class="token operator">=</span> <span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Server</span> server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>            <span class="token comment">// 获取已启动并且可访问的服务列表            List&lt;Server&gt; reachableServers = loadBalancer.getReachableServers();            if (CollectionUtils.isEmpty(reachableServers)) return null;            int idx = ThreadLocalRandom.current().nextInt(reachableServers.size());            server = reachableServers.get(idx);            if (server == null || server.isAlive()) {                log.warn(&quot;Ribbon 服务实例异常, 获取为空 || 状态不健康&quot;);                Thread.yield();                continue;            }            return server;        }    }    ... initWithNiwsConfig 不用实现}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>说一下我们自己实现的 MyRule 负载的逻辑：</p> <ol><li><strong>IRule 获取服务列表没有在调用方实现</strong>，而是抽象 AbstractLoadBalancerRule，所以我们要获取服务列表继承就好了</li> <li>和随机负载规则大致相似，只不过这里简化了流程，<strong>直接从健康的服务实例列表获取 Server 实例</strong></li> <li><strong>确定 Server 不为空并且节点健康后返回</strong>，如果不符合则打印日志，睡一会再重复</li> <li>如果保险起见，<strong>最好在 while 中加入一个循环次数的条件</strong>，避免死循环</li></ol> <p>然后把 MyRule 注册到 SPring IOC 容器中就好了，在初始化时就会代替默认的 Rule 负载规则</p> <h2 id="关于-iping-的思考"><a href="#关于-iping-的思考" class="header-anchor">#</a> 关于 IPing 的思考</h2> <p>在阅读 Ribbon Ping 这一块源代码时，发现了两处个人认为不太合理的地方</p> <ol><li><strong>setPingInterval</strong> 设置 Ping 间隔时执行设置 Ping 任务无意义</li> <li><strong>BaseLoadBalancer</strong> 构造函数中 ping 为 null，<strong>又再次调用了 setPingInterval</strong>，结果只会返回空</li></ol> <p>setPingInterval 和 setPing 两个方法发生在 BaseLoadBalancer 初始化时，相当于接着上面逻辑继续。先说明执行逻辑，再看下不合理的地方</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210124185708642.png" alt=""></p> <p>setupPingTask 用于定期执行对 Server 的 ping 任务，也就是检测 Server 是否可用</p> <p>个人觉得在 setPingInterval 中没有必要执行 setupPingTask 方法</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210124190554174.png" alt=""></p> <p>作出上述结论有以下依据：</p> <ol><li>第一次执行 setPingInterval 时，ping 必然为空，那么会在 canSkipPing 中返回 True，继而直接结束 setPingInterval 方法</li> <li>后来想了下，会不会在别的地方引用，需要强制刷新，然鹅全局搜索了下引用，只有在此次初始化时调用，当然不排除别的依赖包会使用此方法</li> <li>综上所述，setPingInterval 执行设置 Ping 任务的方法无意义</li></ol> <p>另外还有一点，作者感觉代码中调用的方法没有实际意义。和上述类似，都是在 ping 为空时执行了 setPingInterval 方法</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210124192423863.png" alt=""></p> <p>以上这两点是笔者跟源码时，发现不妥当的地方，所以在这里占了一些篇幅说明，主要是想表达两点自己的想法给读者朋友</p> <ol><li><strong>不要对源码有敬畏之心，应该有敬畏之心的是生产环境！</strong> 不要感觉看框架源码是一件高不可攀的事情，其实有时候你理解不了的代码，可能只是多人维护后，混乱的产物，条件允许的情况下，还是要多跟进源码去看一看</li> <li><strong>直言说出自己的见解</strong>，如果只有自己去想，那么很可能没有答案，通过文章间接的方式让更多小伙伴看到，指正错误言论亦或者得到肯定</li></ol> <h2 id="结言"><a href="#结言" class="header-anchor">#</a> 结言</h2> <p>整体来看，文章更 <strong>注重表达设计思想以及源码分析</strong>，所以阅读文章需要一定的源码功底。同时文章是针对问题而展开叙述，哪怕源码不理解也能有所收获</p> <p>Ribbon 这块内容从初始化负载均衡客户端 ILoadBalancer 说起，讲述了初始化过程中具体的内容，包括如何开启 IPing 定时器以及服务列表更新定时器</p> <p>另外通过源码查看到 Ribbon 的服务列表其实是向 <strong>Nacos 提供的接口发起服务调用</strong> 获取并保存到本地缓存，继而牵引出如何保证不健康实例下线：<strong>IPing 定时器和服务更新定时器</strong></p> <p>文末章节说了下请求 Ribbon 负载均衡的全链路以及如何自己定义一个负载均衡算法。最最后面也说了下自己看源码过程中对 SpringCloud IPing 感觉无意义的代码，<em>当然，不排除是为了别的包集成而留下的</em></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9f6db045.js" defer></script><script src="/assets/js/2.ad010850.js" defer></script><script src="/assets/js/28.b05c6b48.js" defer></script>
  </body>
</html>
