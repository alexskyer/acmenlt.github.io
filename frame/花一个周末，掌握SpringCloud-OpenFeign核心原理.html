<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前言 | 龙台技术笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/images/book.png">
    <link rel="manifest" href="/images/book.png">
    <link rel="apple-touch-icon" href="/images/book.png">
    <meta name="description" content="技术人写的技术笔记（工作总结）">
    <meta http-quiv="pragma" cotent="no-cache">
    <meta http-quiv="pragma" cotent="no-cache,must-revalidate">
    <meta http-quiv="expires" cotent="0">
    
    <link rel="preload" href="/assets/css/0.styles.84741abc.css" as="style"><link rel="preload" href="/assets/js/app.1b4c17a3.js" as="script"><link rel="preload" href="/assets/js/2.ad010850.js" as="script"><link rel="preload" href="/assets/js/29.178488c4.js" as="script"><link rel="prefetch" href="/assets/js/10.94d80ba6.js"><link rel="prefetch" href="/assets/js/11.2f420b54.js"><link rel="prefetch" href="/assets/js/12.780d4496.js"><link rel="prefetch" href="/assets/js/13.a5ec8293.js"><link rel="prefetch" href="/assets/js/14.22c75bd2.js"><link rel="prefetch" href="/assets/js/15.a6bc3bc3.js"><link rel="prefetch" href="/assets/js/16.40ca1c91.js"><link rel="prefetch" href="/assets/js/17.1ecdc880.js"><link rel="prefetch" href="/assets/js/18.f657f93c.js"><link rel="prefetch" href="/assets/js/19.76f9fefa.js"><link rel="prefetch" href="/assets/js/20.d7e54280.js"><link rel="prefetch" href="/assets/js/21.87a15fe3.js"><link rel="prefetch" href="/assets/js/22.35a749d4.js"><link rel="prefetch" href="/assets/js/23.dee18ee7.js"><link rel="prefetch" href="/assets/js/24.3179102b.js"><link rel="prefetch" href="/assets/js/25.f4debb1b.js"><link rel="prefetch" href="/assets/js/26.53e571d4.js"><link rel="prefetch" href="/assets/js/27.2649242b.js"><link rel="prefetch" href="/assets/js/28.bd7b7239.js"><link rel="prefetch" href="/assets/js/3.f5671358.js"><link rel="prefetch" href="/assets/js/30.dba7fb10.js"><link rel="prefetch" href="/assets/js/31.321ab434.js"><link rel="prefetch" href="/assets/js/32.12e9a817.js"><link rel="prefetch" href="/assets/js/33.1efba5ba.js"><link rel="prefetch" href="/assets/js/34.e5d5831c.js"><link rel="prefetch" href="/assets/js/35.1ae0fc93.js"><link rel="prefetch" href="/assets/js/36.4d65b835.js"><link rel="prefetch" href="/assets/js/37.6a50545e.js"><link rel="prefetch" href="/assets/js/38.d78bb435.js"><link rel="prefetch" href="/assets/js/39.706e6b6c.js"><link rel="prefetch" href="/assets/js/4.52188786.js"><link rel="prefetch" href="/assets/js/40.f2fd40f1.js"><link rel="prefetch" href="/assets/js/41.b5d516b6.js"><link rel="prefetch" href="/assets/js/42.b865b616.js"><link rel="prefetch" href="/assets/js/43.f9d76365.js"><link rel="prefetch" href="/assets/js/44.a77506c5.js"><link rel="prefetch" href="/assets/js/45.f6c0a8dd.js"><link rel="prefetch" href="/assets/js/46.0ad618af.js"><link rel="prefetch" href="/assets/js/47.0079f20d.js"><link rel="prefetch" href="/assets/js/48.64c7ca11.js"><link rel="prefetch" href="/assets/js/49.43a22984.js"><link rel="prefetch" href="/assets/js/5.59fc555e.js"><link rel="prefetch" href="/assets/js/6.256d2fbb.js"><link rel="prefetch" href="/assets/js/7.0d1e400d.js"><link rel="prefetch" href="/assets/js/8.aab2d760.js"><link rel="prefetch" href="/assets/js/9.902bae2f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.84741abc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">龙台技术笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/home/guide.html" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/db/" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/thread/" class="nav-link">
  并发编程
</a></div><div class="nav-item"><a href="/frame/" class="nav-link router-link-active">
  框架知识
</a></div><div class="nav-item"><a href="/design/" class="nav-link">
  代码设计
</a></div><div class="nav-item"><a href="/bug/" class="nav-link">
  BUG 专栏
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title">其它</span> <span class="arrow down"></span></button> <button type="button" aria-label="其它" class="mobile-dropdown-title"><span class="title">其它</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  动态线程池
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://house.machen.me" target="_blank" rel="noopener noreferrer" class="nav-link external">
  买房实践
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/home/guide.html" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/db/" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/thread/" class="nav-link">
  并发编程
</a></div><div class="nav-item"><a href="/frame/" class="nav-link router-link-active">
  框架知识
</a></div><div class="nav-item"><a href="/design/" class="nav-link">
  代码设计
</a></div><div class="nav-item"><a href="/bug/" class="nav-link">
  BUG 专栏
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title">其它</span> <span class="arrow down"></span></button> <button type="button" aria-label="其它" class="mobile-dropdown-title"><span class="title">其它</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  动态线程池
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://house.machen.me" target="_blank" rel="noopener noreferrer" class="nav-link external">
  买房实践
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前言</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-OpenFeign%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-OpenFeign%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86.html#什么是-feign" class="sidebar-link">什么是 Feign</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-OpenFeign%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86.html#feign-和-openfeign-的区别" class="sidebar-link">Feign 和 Openfeign 的区别</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-OpenFeign%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86.html#starter-openfeign" class="sidebar-link">Starter Openfeign</a></li></ul></li><li><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-OpenFeign%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86.html#环境准备" class="sidebar-link">环境准备</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-OpenFeign%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86.html#生产者服务" class="sidebar-link">生产者服务</a></li><li class="sidebar-sub-header"><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-OpenFeign%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86.html#消费者服务" class="sidebar-link">消费者服务</a></li></ul></li><li><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-OpenFeign%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86.html#feign-的启动原理" class="sidebar-link">Feign 的启动原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-OpenFeign%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86.html#注入-import" class="sidebar-link">注入@Import</a></li><li class="sidebar-sub-header"><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-OpenFeign%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86.html#添加全局配置" class="sidebar-link">添加全局配置</a></li><li class="sidebar-sub-header"><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-OpenFeign%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86.html#注册-feignclient-接口" class="sidebar-link">注册 FeignClient 接口</a></li></ul></li><li><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-OpenFeign%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86.html#feign-的工作原理" class="sidebar-link">Feign 的工作原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-OpenFeign%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86.html#factorybean-接口特征" class="sidebar-link">FactoryBean 接口特征</a></li><li class="sidebar-sub-header"><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-OpenFeign%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86.html#初始化父子容器" class="sidebar-link">初始化父子容器</a></li><li class="sidebar-sub-header"><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-OpenFeign%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86.html#动态代理生成" class="sidebar-link">动态代理生成</a></li></ul></li><li><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-OpenFeign%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86.html#feign-如何负载均衡" class="sidebar-link">Feign 如何负载均衡</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/frame/%E8%8A%B1%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%AB%EF%BC%8C%E6%8E%8C%E6%8F%A1SpringCloud-OpenFeign%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86.html#结语" class="sidebar-link">结语</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>现在的微服务在互联网圈子里应用已经相关广泛了，SpringCloud 是微服务领域当之无愧的 &quot;头牌&quot;</p> <p>加上现在的一些轮子项目，新建一个全套的 SpringCloud 项目分分钟的事情，而我们要做的事情，就是不把认知停留在使用层面，所以要深入到源码中去理解 SpringCloud</p> <p><strong>为什么要选择 OpenFien？</strong> 因为它足够的 &quot;小&quot;，符合我们的标题：<strong>一个周末搞定</strong></p> <p>Feign 的源代码中，Java 代码才 3w 多行，放眼现在热门的开源项目，包括不限于 Dubbo、Naocs、Skywalking 中 Java 代码都要 30w 行起步</p> <p>通过本篇文章，希望读者朋友可以掌握如下知识</p> <ul><li>什么是 Feign</li> <li>Feign 和 Openfeign 的区别</li> <li>OpenFeign 的启动原理</li> <li>OpenFeign 的工作原理</li> <li>OpenFeign 如何负载均衡</li></ul> <blockquote><p>spring-cloud-starter-openfeign version：2.2.6.RELEASE</p></blockquote> <h2 id="什么是-feign"><a href="#什么是-feign" class="header-anchor">#</a> 什么是 Feign</h2> <p>Feign 是声明式 Web 服务客户端，它使编写 Web 服务客户端更加容易</p> <p>Feign 不做任何请求处理，通过处理注解相关信息生成 Request，并对调用返回的数据进行解码，从而实现 <strong>简化 HTTP API 的开发</strong></p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117103547767.png" alt=""></p> <p>如果要使用 Feign，需要创建一个接口并对其添加 Feign 相关注解，另外 Feign <strong>还支持可插拔编码器和解码器</strong>，致力于打造一个轻量级 HTTP 客户端</p> <h2 id="feign-和-openfeign-的区别"><a href="#feign-和-openfeign-的区别" class="header-anchor">#</a> Feign 和 Openfeign 的区别</h2> <p>Feign 最早是由 <strong>Netflix 公司进行维护的</strong>，后来 Netflix 不再对其进行维护，最终 <strong>Feign 由社区进行维护</strong>，更名为 Openfeign</p> <blockquote><p>为了少打俩字，下文简称 Opefeign 为 Feign</p></blockquote> <p>并将原项目迁移至新的仓库，所以我们在 Github 上看到 Feign 的坐标如下</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="starter-openfeign"><a href="#starter-openfeign" class="header-anchor">#</a> Starter Openfeign</h3> <p>当然了，基于 SpringCloud 团队对 Netflix 的情有独钟，你出了这么好用的轻量级 HTTP 客户端，我这老大哥不得支持一下，所以就有了基于 Feign 封装的 Starter</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Spring Cloud 添加了对 Spring MVC 注解的支持，并支持使用 Spring Web 中默认使用的相同 HttpMessageConverters</p> <p>另外，Spring Cloud 老大哥同时集成了 Ribbon 和 Eureka 以及 Spring Cloud LoadBalancer，以在使用 Feign 时提供负载均衡的 HTTP 客户端</p> <blockquote><p>针对于注册中心的支持，包含但不限于 Eureka，比如 Consul、Naocs 等注册中心均支持</p></blockquote> <p>在我们 SpringCloud 项目开发过程中，使用的大多都是这个 Starter Feign</p> <h2 id="环境准备"><a href="#环境准备" class="header-anchor">#</a> 环境准备</h2> <p>为了方便大家理解，这里写出对应的生产方、消费方 Demo 代码，以及使用的注册中心</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117200427532.png" alt=""></p> <p>注册中心使用的 Nacos，生产、消费方代码都比较简单。另外为了阅读体验感，<strong>文章原则是少放源码</strong>，更多的是给大家梳理核心逻辑</p> <h3 id="生产者服务"><a href="#生产者服务" class="header-anchor">#</a> 生产者服务</h3> <p>添加 Nacos 服务注册发现注解以及发布出 HTTP 接口服务</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@EnableDiscoveryClient</span> <span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NacosProduceApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">NacosProduceApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@RestController</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hello&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;hello &quot;</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="消费者服务"><a href="#消费者服务" class="header-anchor">#</a> 消费者服务</h3> <p>定义 FeignClient 消费服务接口</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;nacos-produce&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">DemoFeignClient</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/hello&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>因为生产者使用 Nacos，所以消费者除了开启 Feign 注解，同时也要开启 Naocs 服务注册发现</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span> <span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span> <span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NacosConsumeApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">NacosConsumeApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Autowired</span> <span class="token keyword">private</span> <span class="token class-name">DemoFeignClient</span> demoFeignClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> demoFeignClient<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">&quot;公号-源码兴趣圈&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="feign-的启动原理"><a href="#feign-的启动原理" class="header-anchor">#</a> Feign 的启动原理</h2> <p>我们在 SpringCloud 的使用过程中，如果想要启动某个组件，一般都是 <strong>@Enable...</strong> 这种方式注入，Feign 也不例外，我们需要在类上标记此注解 <code>@EnableFeignClients</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>继续深入看一下注解内部都做了什么。注解内部的方法就不说明了，不加会有默认的配置，感兴趣可以跟下源码</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">FeignClientsRegistrar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">EnableFeignClients</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>前三个注解看着平平无奇，重点在第四个 @Import 上，一般使用此注解都是想要动态注册 Spring Bean 的</p> <h3 id="注入-import"><a href="#注入-import" class="header-anchor">#</a> 注入@Import</h3> <p>通过名字也可以大致猜出来，这是 Feign 注册 Bean 使用的，使用到了 Spring 相关的接口，一起看下起了什么作用</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210116215150734.png" alt=""></p> <p>ResourceLoaderAware、EnvironmentAware 为 FeignClientsRegistrar 中两个属性 <strong>resourceLoader、environment</strong> 赋值，对 Spring 了解的小伙伴理解问题不大</p> <p>ImportBeanDefinitionRegistrar 负责动态注入 IOC Bean，分别注入 Feign 配置类、FeignClient Bean</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 资源加载器，可以加载 classpath 下的所有文件</span>
<span class="token keyword">private</span> <span class="token class-name">ResourceLoader</span> resourceLoader<span class="token punctuation">;</span>
<span class="token comment">// 上下文，可通过该环境获取当前应用配置属性等</span>
<span class="token keyword">private</span> <span class="token class-name">Environment</span> environment<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setEnvironment</span><span class="token punctuation">(</span><span class="token class-name">Environment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>environment <span class="token operator">=</span> environment<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setResourceLoader</span><span class="token punctuation">(</span><span class="token class-name">ResourceLoader</span> resourceLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader <span class="token operator">=</span> resourceLoader<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> metadata<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">// 注册 ＠EnableFeignClients 提供的自定义配置类中的相关 Bean 实例</span>
    <span class="token function">registerDefaultConfiguration</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 扫描 packge，注册被 @FeignClient 修饰的接口类为 IOC Bean</span>
    <span class="token function">registerFeignClients</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="添加全局配置"><a href="#添加全局配置" class="header-anchor">#</a> 添加全局配置</h3> <p>registerDefaultConfiguration 方法流程如下</p> <ol><li>获取 @EnableFeignClients 注解上的属性以及对应 Value</li> <li>生成 <strong>FeignClientSpecification</strong>（存储 Feign 中的配置类） 对应的构造器 BeanDefinitionBuilder</li> <li>FeignClientSpecification Bean 名称为 default. + @EnableFeignClients 修饰类全限定名称 + FeignClientSpecification</li> <li>@EnableFeignClients defaultConfiguration 默认为 {}，如果没有相关配置，<code>默认使用 FeignClientsConfiguration</code> 并结合 name 填充到 FeignClientSpecification，最终注册为 IOC Bean</li></ol> <h3 id="注册-feignclient-接口"><a href="#注册-feignclient-接口" class="header-anchor">#</a> 注册 FeignClient 接口</h3> <p>将重点放在 registerFeignClients 上，该方法主要就是将修饰了 @FeignClient 的接口注册为 IOC Bean</p> <ol><li>扫描 @EnableFeignClients 注解，如果有 clients，则加载指定接口，为空则根据 scanner 规则扫描出修饰了 @FeignClient 的接口</li> <li>获取 @FeignClient 上对应的属性，根据 configuration 属性去创建接口级的 <strong>FeignClientSpecification</strong> 配置类 IOC Bean</li> <li>将 @FeignClient 的属性设置到 <strong>FeignClientFactoryBean</strong> 对象上，并注册 IOC Bean</li></ol> <p>@FengnClient 修饰的接口实际上使用了 Spring 的代理工厂生成代理类，所以这里会把修饰了 @FeignClient 接口的 BeanDefinition 设置为 FeignClientFactoryBean 类型，而 <strong>FeignClientFactoryBean 继承自 FactoryBean</strong></p> <p>也就是说，当我们定义 @FeignClient 修饰接口时，注册到 IOC 容器中 Bean 类型变成了 FeignClientFactoryBean</p> <p>在 Spring 中，FactoryBean 是一个工厂 Bean，用来创建代理 Bean。<strong>工厂 Bean 是一种特殊的 Bean</strong>，对于需要获取 Bean 的消费者而言，它是不知道 Bean 是普通 Bean 或是工厂 Bean 的。<strong>工厂 Bean 返回的实例不是工厂 Bean 本身</strong>，而是会返回执行了工厂 Bean 中 <code>FactoryBean#getObject</code> 逻辑的实例</p> <h2 id="feign-的工作原理"><a href="#feign-的工作原理" class="header-anchor">#</a> Feign 的工作原理</h2> <p>说 Feign 的工作原理，核心点围绕在被 @FeignClient 修饰的接口，如何发送及接收 HTTP 网络请求</p> <p>上面说到 @FeignClient 修饰的接口最终填充到 IOC 容器的类型是 FeignClientFactoryBean，先来看下它是什么</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117084610770.png" alt=""></p> <h3 id="factorybean-接口特征"><a href="#factorybean-接口特征" class="header-anchor">#</a> FactoryBean 接口特征</h3> <p>这里说一下 FeignClientFactoryBean 都有哪些特征</p> <ol><li>它会在类初始化时执行一段逻辑，依据 Spring <strong>InitializingBean</strong> 接口</li> <li>如果它被别的类 @Autowired 进行注入，返回的不是它本身，而是 <code>FactoryBean#getObject</code> 返回的类，依据 Spring <strong>FactoryBean</strong> 接口</li> <li>它能够获取 Spring 上下文对象，依据 Spring <strong>ApplicationContextAware</strong> 接口</li></ol> <p>先来看它的初始化逻辑都执行了什么</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Overridepublic</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>contextId<span class="token punctuation">,</span> <span class="token string">&quot;Context id must be set&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">&quot;Name must be set&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>没有特别的操作，只是使用断言工具类判断两个字段不为空。ApplicationContextAware 也没什么说的，获取上下文对象赋值到对象的局部变量里，重点以及关键就是 <code>FactoryBean#getObject</code> 方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Overridepublic</span> <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>getTarget 源码方法还是挺长的，这里采用分段的形式展示</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  	<span class="token comment">// 从 IOC 容器获取 FeignContext    FeignContext context = applicationContext.getBean(FeignContext.class);  	// 通过 context 创建 Feign 构造器    Feign.Builder builder = feign(context);		...}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这里提出一个疑问？FeignContext 什么时候、在哪里被注入到 Spring 容器里的？</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117124204635.png" alt=""></p> <p>看到图片小伙伴就明了了，用了 SpringBoot 怎么会不使用自动装配的功能呢，FeignContext 就是在 FeignAutoConfiguration 中被成功创建</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117135517855.png" alt=""></p> <h3 id="初始化父子容器"><a href="#初始化父子容器" class="header-anchor">#</a> 初始化父子容器</h3> <p>feign 方法里日志工厂、编码、解码等类均是通过 get(...) 方法得到</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117140151921.png" alt=""></p> <p>这里涉及到 Spring 父子容器的概念，<strong>默认子容器 Map 为空</strong>，获取不到服务名对应 Context 则新建</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117140635516.png" alt=""></p> <p>从下图中看到，注册了一个 <strong>FeignClientsConfiguration</strong> 类型的 Bean，我们上述方法 feign 中的获取的编码、解码器等组件都是从此类中获取默认</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117141800121.png" alt=""></p> <p>默认注册如下，FeignClientsConfiguration 是由创建 FeignContext 调用父类 Super 构造方法传入的</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117142442921.png" alt=""></p> <p>关于父子类容器对应关系，以及提供 @FeignClient 服务对应子容器的关系（每一个服务对应一个子容器实例）</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117144335432.png" alt=""></p> <p>回到 getInstance 方法，子容器此时已加载对应 Bean，直接通过 getBean 获取 <strong>FeignLoggerFactory</strong></p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117142639778.png" alt=""></p> <p>如法炮制，Feign.Builder、Encoder、Decoder、Contract 都可以通过子容器获取对应 Bean</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117145054652.png" alt=""></p> <p>configureFeign 方法主要进行一些配置赋值，<strong>比如超时、重试、404 配置等</strong>，就不再细说赋值代码了</p> <p>到这里有必要总结一下创建 Spring 代理工厂的前半场代码</p> <ol><li>注入@FeignClient 服务时，其实注入的是 <code>FactoryBean#getObject</code> 返回代理工厂对象</li> <li>通过 IOC 容器获取 FeignContext 上下文</li> <li>创建 Feign.Builder 对象时会创建 Feign 服务对应的子容器</li> <li>从子容器中获取日志工厂、编码器、解码器等 Bean</li> <li>为 Feign.Builder 设置配置，比如超时时间、日志级别等属性，每一个服务都可以个性化设置</li></ol> <h3 id="动态代理生成"><a href="#动态代理生成" class="header-anchor">#</a> 动态代理生成</h3> <p>继续嗑，上面都是开胃菜，接下来是最最最重要的地方了，小板凳坐板正了..</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117160135560.png" alt=""></p> <p>因为我们在 @FeignClient 注解是使用 name 而不是 url，所以会执行负载均衡策略的分支</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117165403532.png" alt=""></p> <p>Client： Feign 发送请求以及接收响应等都是由 Client 完成，该类默认 Client.Default，另外支持 HttpClient、OkHttp 等客户端</p> <p>代码中的 Client、Targeter 在自动装配时注册，配合上文中的父子容器理论，这两个 Bean 在父容器中存在</p> <p>因为我们并没有对 Hystix 进行设置，所以走入此分支</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117165809307.png" alt=""></p> <p>创建反射类 ReflectiveFeign，然后执行创建实例类</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117170636104.png" alt=""></p> <p>newInstance 方法对 @FeignClient 修饰的接口中 SpringMvc 等配置进行解析转换，对接口类中的方法进行归类，生成动态代理类</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117180843295.png" alt=""></p> <p>可以看出 Feign 创建动态代理类的方式和 Mybatis Mapper 处理方式是一致的，因为两者都没有实现类</p> <p>根据 newInstance 方法按照行为大致划分，共做了四件事</p> <ol><li>处理 @FeignCLient 注解（SpringMvc 注解等）封装为 <strong>MethodHandler</strong> 包装类</li> <li>遍历接口中所有方法，过滤 Object 方法，并将默认方法以及 FeignClient 方法分类</li> <li>创建动态代理对应的 <strong>InvocationHandler</strong> 并创建 Proxy 实例</li> <li>接口内 default 方法 <strong>绑定动态代理类</strong></li></ol> <p>MethodHandler 将方法参数、方法返回值、参数集合、请求类型、请求路径进行解析存储</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117181818113.png" alt=""></p> <p>到这里我们也就可以 Feign 的工作方式了。前面那么多封装铺垫，封装个性化配置等等，最终确定收尾的是创建动态代理类</p> <p>也就是说在我们调用 @FeignClient 接口时，会被 <code>FeignInvocationHandler#invoke</code> 拦截，并在动态代理方法中执行下述逻辑</p> <ol><li>接口注解信息封装为 HTTP Request</li> <li>通过 Ribbon 获取服务列表，并对服务列表进行负载均衡调用（<strong>服务名转换为 ip+port</strong>）</li> <li>请求调用后，将返回的数据封装为 HTTP Response，继而转换为接口中的返回类型</li></ol> <p>既然已经明白了调用流程，那就正儿八经的试一哈，试过才知有没有...</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117185730122.png" alt=""></p> <p>RequestTemplate：构建 Request 模版类</p> <p>Options：存放连接、超时时间等配置类</p> <p>Retryer：失败重试策略类</p> <blockquote><p>重试这一块逻辑看了很多遍，但是怎么看，一个 continue 关键字放到 while 的最后面都有点多余...</p></blockquote> <p>执行远端调用逻辑中使用到了 <strong>Rxjava （响应式编程）</strong>，可以看到通过底层获取 server 后将服务名称转变为 ip+port 的方式</p> <p>这种响应式编程的方式在 SpringCloud 中很常见，<strong>Hystix 源码底层也有使用</strong></p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117192026553.png" alt=""></p> <p>网络调用默认使用 <strong>HttpURLConnection</strong>，可以配置使用 HttpClient 或者 OkHttp</p> <p>调用远端服务后，再将返回值解析正常返回，到这里一个完成的 Feign 调用链就聊明白了</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117221147470.png" alt="图片参考@疯狂创客圈"></p> <h2 id="feign-如何负载均衡"><a href="#feign-如何负载均衡" class="header-anchor">#</a> Feign 如何负载均衡</h2> <p>一般而言，我们生产者注册多个服务，消费者调用时需要使用负载均衡从中 <strong>选取一个健康并且可用的生产者服务</strong></p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117211229930.png" alt=""></p> <p>因为 Feign 内部集成 Ribbon，所以也支持此特性，一起看下它是怎么做的</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117201548333.png" alt=""></p> <p>我们在 Nacos 上注册了两个服务，端口号 8080、8081。在获取负载均衡器时就可以获取服务集合</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117202046064.png" alt=""></p> <p>然后通过 chooseServer 方法选择一个健康实例返回，后面会新出一篇文章对 Ribbon 的负载均衡详细说明</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210117202719314.png" alt=""></p> <p>通过返回的 Server 替换 URL 中的服务名，最后使用网络调用服务进行远端调用，完美的一匹</p> <h2 id="结语"><a href="#结语" class="header-anchor">#</a> 结语</h2> <p>文章从最基础的知识介绍什么是 Feign？继而从源码的角度上说明 Feign 的底层原理，总结如下：</p> <ol><li>通过 @EnableFeignCleints 注解启动 Feign Starter 组件</li> <li>Feign Starter 在项目启动过程中注册全局配置，扫描包下所有的 @FeignClient 接口类，并进行注册 IOC 容器</li> <li>@FeignClient 接口类被注入时，通过 <code>FactoryBean#getObject</code> 返回动态代理类</li> <li>接口被调用时被动态代理类逻辑拦截，将 @FeignClient 请求信息通过编码器生成 Request</li> <li>交由 Ribbon 进行负载均衡，挑选出一个健康的 Server 实例</li> <li>继而通过 Client 携带 Request 调用远端服务返回请求响应</li> <li>通过解码器生成 Response 返回客户端，将信息流解析成为接口返回数据</li></ol> <p>虽然 Feign 体量相对小，但是想要一篇文章完全描述，也不太现实，所以这里都是挑一些核心点讲解，没有写到的地方还请见谅</p> <p>另外，由于作者水平有限, 欢迎大家能够反馈指正文章中错误不正确的地方, 感谢</p> <br> <p><strong>参考文章：</strong></p> <ul><li>https://blog.csdn.net/forezp/article/details/73480304</li> <li>https://www.cnblogs.com/yangxiaohui227/p/12965340.html</li> <li>https://www.cnblogs.com/crazymakercircle/p/11965726.html</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1b4c17a3.js" defer></script><script src="/assets/js/2.ad010850.js" defer></script><script src="/assets/js/29.178488c4.js" defer></script>
  </body>
</html>
