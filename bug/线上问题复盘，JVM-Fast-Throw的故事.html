<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>龙台技术笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/images/book.png">
    <link rel="manifest" href="/images/book.png">
    <link rel="apple-touch-icon" href="/images/book.png">
    <meta name="description" content="技术人写的技术笔记（工作总结）">
    <meta http-quiv="pragma" cotent="no-cache">
    <meta http-quiv="pragma" cotent="no-cache,must-revalidate">
    <meta http-quiv="expires" cotent="0">
    
    <link rel="preload" href="/assets/css/0.styles.84741abc.css" as="style"><link rel="preload" href="/assets/js/app.1b4c17a3.js" as="script"><link rel="preload" href="/assets/js/2.ad010850.js" as="script"><link rel="preload" href="/assets/js/12.780d4496.js" as="script"><link rel="prefetch" href="/assets/js/10.94d80ba6.js"><link rel="prefetch" href="/assets/js/11.2f420b54.js"><link rel="prefetch" href="/assets/js/13.a5ec8293.js"><link rel="prefetch" href="/assets/js/14.22c75bd2.js"><link rel="prefetch" href="/assets/js/15.a6bc3bc3.js"><link rel="prefetch" href="/assets/js/16.40ca1c91.js"><link rel="prefetch" href="/assets/js/17.1ecdc880.js"><link rel="prefetch" href="/assets/js/18.f657f93c.js"><link rel="prefetch" href="/assets/js/19.76f9fefa.js"><link rel="prefetch" href="/assets/js/20.d7e54280.js"><link rel="prefetch" href="/assets/js/21.87a15fe3.js"><link rel="prefetch" href="/assets/js/22.35a749d4.js"><link rel="prefetch" href="/assets/js/23.dee18ee7.js"><link rel="prefetch" href="/assets/js/24.3179102b.js"><link rel="prefetch" href="/assets/js/25.f4debb1b.js"><link rel="prefetch" href="/assets/js/26.53e571d4.js"><link rel="prefetch" href="/assets/js/27.2649242b.js"><link rel="prefetch" href="/assets/js/28.bd7b7239.js"><link rel="prefetch" href="/assets/js/29.178488c4.js"><link rel="prefetch" href="/assets/js/3.f5671358.js"><link rel="prefetch" href="/assets/js/30.dba7fb10.js"><link rel="prefetch" href="/assets/js/31.321ab434.js"><link rel="prefetch" href="/assets/js/32.12e9a817.js"><link rel="prefetch" href="/assets/js/33.1efba5ba.js"><link rel="prefetch" href="/assets/js/34.e5d5831c.js"><link rel="prefetch" href="/assets/js/35.1ae0fc93.js"><link rel="prefetch" href="/assets/js/36.4d65b835.js"><link rel="prefetch" href="/assets/js/37.6a50545e.js"><link rel="prefetch" href="/assets/js/38.d78bb435.js"><link rel="prefetch" href="/assets/js/39.706e6b6c.js"><link rel="prefetch" href="/assets/js/4.52188786.js"><link rel="prefetch" href="/assets/js/40.f2fd40f1.js"><link rel="prefetch" href="/assets/js/41.b5d516b6.js"><link rel="prefetch" href="/assets/js/42.b865b616.js"><link rel="prefetch" href="/assets/js/43.f9d76365.js"><link rel="prefetch" href="/assets/js/44.a77506c5.js"><link rel="prefetch" href="/assets/js/45.f6c0a8dd.js"><link rel="prefetch" href="/assets/js/46.0ad618af.js"><link rel="prefetch" href="/assets/js/47.0079f20d.js"><link rel="prefetch" href="/assets/js/48.64c7ca11.js"><link rel="prefetch" href="/assets/js/49.43a22984.js"><link rel="prefetch" href="/assets/js/5.59fc555e.js"><link rel="prefetch" href="/assets/js/6.256d2fbb.js"><link rel="prefetch" href="/assets/js/7.0d1e400d.js"><link rel="prefetch" href="/assets/js/8.aab2d760.js"><link rel="prefetch" href="/assets/js/9.902bae2f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.84741abc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">龙台技术笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/home/guide.html" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/db/" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/thread/" class="nav-link">
  并发编程
</a></div><div class="nav-item"><a href="/frame/" class="nav-link">
  框架知识
</a></div><div class="nav-item"><a href="/design/" class="nav-link">
  代码设计
</a></div><div class="nav-item"><a href="/bug/" class="nav-link router-link-active">
  BUG 专栏
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title">其它</span> <span class="arrow down"></span></button> <button type="button" aria-label="其它" class="mobile-dropdown-title"><span class="title">其它</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  动态线程池
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://house.machen.me" target="_blank" rel="noopener noreferrer" class="nav-link external">
  买房实践
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/home/guide.html" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/db/" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/thread/" class="nav-link">
  并发编程
</a></div><div class="nav-item"><a href="/frame/" class="nav-link">
  框架知识
</a></div><div class="nav-item"><a href="/design/" class="nav-link">
  代码设计
</a></div><div class="nav-item"><a href="/bug/" class="nav-link router-link-active">
  BUG 专栏
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title">其它</span> <span class="arrow down"></span></button> <button type="button" aria-label="其它" class="mobile-dropdown-title"><span class="title">其它</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  动态线程池
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://house.machen.me" target="_blank" rel="noopener noreferrer" class="nav-link external">
  买房实践
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bug/%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98%E5%A4%8D%E7%9B%98%EF%BC%8CJVM-Fast-Throw%E7%9A%84%E6%95%85%E4%BA%8B.html#jvm-fast-throw" class="sidebar-link">JVM Fast Throw</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bug/%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98%E5%A4%8D%E7%9B%98%EF%BC%8CJVM-Fast-Throw%E7%9A%84%E6%95%85%E4%BA%8B.html#模拟-fast-throw" class="sidebar-link">模拟 Fast Throw</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bug/%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98%E5%A4%8D%E7%9B%98%EF%BC%8CJVM-Fast-Throw%E7%9A%84%E6%95%85%E4%BA%8B.html#结言" class="sidebar-link">结言</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>首先，这是一个 <strong>悲伤的故事</strong>，涉及到JVM 底层优化的知识点。想到第一次碰到这种问题时的懵逼，应了句老话：<strong>书到用时方恨少！</strong></p> <p>负责的消息中台在 <strong>晚上八点左右</strong>，运维群里反馈大量用户接收不到短信消息。登陆 Kibana 查找对应的 Error 日志，发现出现了 <strong>大量的下标越界异常</strong></p> <p>当时更...，线上问题得到了修复。但是，出现问题可不得找到问题的产出原因，不然下次有可能还会出现</p> <p>因为在 ELK 上进行 <strong>日志分析不太方便</strong>，难以根据对应异常进行不同纬度上的统计分析，所以联系运维同学将故障产生当天的 <strong>Info、Error 日志</strong> 拉下来进行线下分析</p> <p>经过日志分析得知，异常的产出有两种，<strong>一种是有堆栈信息</strong>，比如：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ArrayIndexOutOfBoundsException</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 省略堆栈信息
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>另外一种，就比较诡异，<strong>只有异常，没有对应的堆栈信息</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ArrayIndexOutOfBoundsException</span><span class="token operator">:</span> <span class="token keyword">null</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>第一种问题比较好定位，根据 <strong>异常堆栈信息</strong>，定位到了具体代码，直接进行了修复，难就难在第二种</p> <p><strong>其实这两个是一个异常</strong>，往后看小伙伴就明白了。后面做的所有事情，都是为了搞清楚两件事情</p> <ul><li>为什么异常 message 会输出 null</li> <li>为什么堆栈信息没有输出打印</li></ul> <h2 id="jvm-fast-throw"><a href="#jvm-fast-throw" class="header-anchor">#</a> JVM Fast Throw</h2> <p><strong>什么是 Fast Throw？</strong></p> <p>大白话一点来说，就是：当一些异常类型（空指针、下标越界、算术运算等...）在代码里的固定位置被抛出多次，虚拟机（HotSpot VM）会直接 <strong>抛出一个事先分配好、类型匹配的异常对象</strong>。此异常对象的 <strong>message 和 stack trace 都为空</strong></p> <p>看到这里相信读者朋友已经明白了为什么同一种异常，<strong>打印出来的日志却是不一样内容</strong> 了吧。就是因为某一个异常在同一个地方多次被抛出，JVM 抛出一个预分配异常，那么 <strong>message、stack trace 相当于被吞掉了</strong></p> <blockquote><p>The compiler in the server VM now provides correct stack backtraces for all &quot;cold&quot; built-in exceptions. For performance purposes, when such an exception is thrown a few times, the method may be recompiled. After recompilation, the compiler may choose a faster tactic using preallocated exceptions that do not provide a stack trace. To disable completely the use of preallocated exceptions, use this new flag: <strong>-XX:-OmitStackTraceInFastThrow.</strong></p></blockquote> <p>JDK 1.5 的发布文档介绍中描述了此情况，出现这种优化方案的原因是 <strong>为了提高性能</strong>。当同一种异常在相同的位置被抛出多次，<strong>编译器就会重新编译此方法</strong>。重编译后，编译器可能会 <strong>使用不提供堆栈跟踪的预分配异常</strong> 来选择更快的策略</p> <p>如果想要关闭这种预分配异常的机制，可以使用 <strong>-XX:-OmitStackTraceInFastThrow</strong>。感兴趣的读者朋友可以看一下发布说明：<code>https://sourl.cn/PMzVkC</code></p> <p>另外通过 JVM 的源码得知，Fast Throw 机制目前支持五种异常情况，截图如下</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/34bf1837-6d11-4228-9e76-f6d0e7bfeef7.png" alt=""></p> <h2 id="模拟-fast-throw"><a href="#模拟-fast-throw" class="header-anchor">#</a> 模拟 Fast Throw</h2> <p>上面说的都是理论部分，这个章节使用代码来实战下</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> length <span class="token operator">=</span> ex<span class="token punctuation">.</span><span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;报错异常 :: %s, 堆栈长度 :: %s&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>上面程序跑在了 Java8 的环境中，通过运行程序结果可以看出来，Fast Throw 在 Java 8 中依然生效</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/96b65751-42fd-4ea1-8d83-5a5b3cbd71cf.png" alt=""></p> <p><strong>如果没有特别情况，最好不要关闭此特性</strong>。因为如果并发量大的接口，因为程序的 BUG 导致大量的请求在同一代码处抛出异常，<strong>Fast Throw 机制可以节省很多性能损耗</strong>。通过单线程跑测试 Demo 得知，异常调用情况越多，性能差别越大</p> <table><thead><tr><th></th> <th>开启  Fast Throw</th> <th>关闭 Fast Throw</th></tr></thead> <tbody><tr><td>10w</td> <td>1004ms</td> <td>3547ms</td></tr> <tr><td>100 w</td> <td>6193ms</td> <td>30928ms</td></tr> <tr><td>500w</td> <td>37492ms</td> <td>...</td></tr></tbody></table> <p>如果线上环境触发了 Fast Throw 机制，可以通过 <strong>向前追溯相同位置、相同异常的日志</strong> 来定位问题的产出原因</p> <h2 id="结言"><a href="#结言" class="header-anchor">#</a> 结言</h2> <p>千言万语汇成一句话就是，<em><strong>重构有风险，上线需谨慎</strong></em></p> <p>针对公共功能的重构，<strong>需要包含全量的测试用例</strong>，要将可能会出现的问题产出背景考虑到 <strong>极致</strong>，亦或者和身边同事说明需求背景，大家一起想下，可以极大程度避免极端问题的产出</p> <p><strong>必要的压力测试</strong> 是很重要的，这一点可以很好的将 <strong>流量大才能显现的问题</strong> 提前暴露出来</p> <p>故障的产生带来的意义，有好有坏，坏的点大家都懂得；好的点自然是 <strong>积累了线上问题故障排查的经验</strong>，这样的话，后面公司妹子再遇到相同的问题，大喊一声：<strong>妹子，放开那 BUG，让我来！</strong></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1b4c17a3.js" defer></script><script src="/assets/js/2.ad010850.js" defer></script><script src="/assets/js/12.780d4496.js" defer></script>
  </body>
</html>
