(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{373:function(s,t,a){"use strict";a.r(t);var n=a(45),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("公司内部使用 oss 作为文件存储服务器，测试提出一个使用 chrome 浏览器下载文件的 bug")]),s._v(" "),a("p",[a("strong",[s._v("ERR_RESPONSE_HEADERS_MULTIPLE_CONTENT_DISPOSITION")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201218135332237.png",alt:""}})]),s._v(" "),a("p",[s._v("具体上传下载流程如下：")]),s._v(" "),a("ol",[a("li",[s._v("使用 chrome 浏览器上传文件名称包含英文半角逗号的文件")]),s._v(" "),a("li",[s._v("上传操作成功，根据 oss 中文件 url 进行下载操作")]),s._v(" "),a("li",[s._v("请求可以正常发出，但是响应时浏览器发生崩溃现象，页面提示错误")]),s._v(" "),a("li",[s._v("其它浏览器无此问题，多处查看判断为谷歌浏览器问题，暂定义为 bug")])]),s._v(" "),a("p",[s._v("下面会根据步骤说明此问题的出现，并给出问题结论")]),s._v(" "),a("h2",{attrs:{id:"环境配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#环境配置"}},[s._v("#")]),s._v(" 环境配置")]),s._v(" "),a("p",[s._v("oss 上传文件在官网给出很多种案例，以及不同语言的 sdk，文章演示 java sdk 基于文件流的形式上传")]),s._v(" "),a("p",[a("strong",[s._v("chrome 版本")])]),s._v(" "),a("p",[s._v("版本 87.0.4280.88（正式版本） (x86_64)")]),s._v(" "),a("p",[a("strong",[s._v("oss sdk")])]),s._v(" "),a("p",[s._v("虽然不是最新的，但是文章所描述问题与 oss sdk 版本无关，因为挨个试过 🙃️")]),s._v(" "),a("div",{staticClass:"language-xml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!-- https://mvnrepository.com/artifact/com.aliyun.oss/aliyun-sdk-oss --\x3e")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("com.aliyun.oss"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("aliyun-sdk-oss"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("3.10.2"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[a("strong",[s._v("springboot 版本")])]),s._v(" "),a("div",{staticClass:"language-xml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("parent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("org.springframework.boot"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("spring-boot-starter-parent"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("2.2.11.RELEASE"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("relativePath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("/>")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!-- lookup parent from repository --\x3e")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("parent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h2",{attrs:{id:"oss-文件上传"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#oss-文件上传"}},[s._v("#")]),s._v(" oss 文件上传")]),s._v(" "),a("p",[s._v("首先我们先来模拟 oss 上传文件的流程，下图是 oss 官方提供的代码示例，我们加以参考")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201218161203295.png",alt:""}})]),s._v(" "),a("h3",{attrs:{id:"定义上传接口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#定义上传接口"}},[s._v("#")]),s._v(" 定义上传接口")]),s._v(" "),a("p",[s._v("以下代码为自己搭建项目实现，模拟出错链路")]),s._v(" "),a("p",[s._v("使用 swagger2 展示可视化 ui 界面上传文件，入参分别是 oss backet 桶名称、文件")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201218175352570.png",alt:""}})]),s._v(" "),a("p",[s._v("这一块参考了 oss 官方提供的 java sdk 示例代码，一共分为以下几个步骤")]),s._v(" "),a("ol",[a("li",[s._v("根据 endpoint、accessKeyId、accessKeySecret 创建 oss 客户端")]),s._v(" "),a("li",[s._v("获取文件流、（uuid + 扩展名）oss 文件名进行上传")]),s._v(" "),a("li",[s._v("拼接可访问的 url 返回前端")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201218175829081.png",alt:""}})]),s._v(" "),a("p",[s._v("代码既然都写好了，光说不练假把式，上传个文件试试水")]),s._v(" "),a("p",[s._v("我们上传的 Pdf 文件是个空的，文件名中包含了英文半角的逗号，上传到 oss 之后通过访问返回 url 测试刚才的问题")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201218180555192.png",alt:""}})]),s._v(" "),a("p",[s._v("浏览器输入 url 返回 pdf 文件，因为是个空文件，所以一片空白。问题来了："),a("strong",[s._v("不是说上传文件名称包含英文半角逗号会报错么")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201218180914624.png",alt:""}})]),s._v(" "),a("p",[a("strong",[s._v("其实如果是预览文件，不会出现文初的问题报错")]),s._v("。但是，前端需要根据文件 url "),a("strong",[s._v("下载文件到本地")])]),s._v(" "),a("p",[s._v("目前作者知道两种方式实现访问文件 url 做到下载本地的功能")]),s._v(" "),a("ol",[a("li",[s._v("前端请求后端接口，获取到文件 oss url 以及文件原名称；前端访问 oss url 地址，通过返回文件流以及文件原本名称包装进行下载到本地")]),s._v(" "),a("li",[s._v("通过修改 oss url 中的 http head 直接下载文件，这也是目前公司在使用的一种方式，问题也就出在这")])]),s._v(" "),a("h3",{attrs:{id:"修改文件上传"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#修改文件上传"}},[s._v("#")]),s._v(" 修改文件上传")]),s._v(" "),a("p",[s._v("修改上传的部分代码，使得访问 oss url 实现下载文件功能")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201218182357776.png",alt:""}})]),s._v(" "),a("p",[s._v("上图圈起来的代码等效与在 oss 控制台设置文件 http head，把文件原名称标记为附件名称，以此实现下载功能")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201218182946330.png",alt:""}})]),s._v(" "),a("p",[s._v("问题出就出在这里，经过实际测试，fileName 中不加双引号并且包含英文半角逗号会导致报错，"),a("strong",[s._v("其它浏览器并无此问题")])]),s._v(" "),a("h2",{attrs:{id:"问题解决"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题解决"}},[s._v("#")]),s._v(" 问题解决")]),s._v(" "),a("p",[s._v("本来都准备让前端 "),a("strong",[s._v("拦截带英文逗号或者把英文逗号替换称中文逗号")]),s._v("，但是本着 "),a("strong",[s._v("认(强)真(迫)负(症)责")]),s._v(" 的态度咨询了阿里云工单客服(小哥哥or小姐姐)")]),s._v(" "),a("p",[s._v("给出相关思路，服务器端函数响应中若设置 http head content-disposition，"),a("strong",[s._v("需要确保 filename 参数使用双引号包裹")])]),s._v(" "),a("p",[s._v("目前已知 fileName 中如果不包含英文逗号，即使不加双引号也没有问题")]),s._v(" "),a("p",[s._v("修改相关代码，把文件 http head 中 content-disposition fileName 使用双引号包起来")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201218184337110.png",alt:""}})]),s._v(" "),a("p",[s._v("设置 http head content-disposition 中实际效果如：")]),s._v(" "),a("p",[a("strong",[s._v('content-disposition=attachment;fileName="原文件名称"')])]),s._v(" "),a("p",[s._v("经过实际测试，火狐、safari 等其它浏览器同样适配此改动")]),s._v(" "),a("h2",{attrs:{id:"结言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#结言"}},[s._v("#")]),s._v(" 结言")]),s._v(" "),a("p",[s._v("通过 chrome 浏览器下载文件报错的问题，引发了一系列猜测及测试，最终完成修改更正")]),s._v(" "),a("p",[s._v("经历此次问题也收获了很多知识，以此证明工作中解决的疑难杂症都是以后 coding 路上的收获，very nice")])])}),[],!1,null,null,null);t.default=e.exports}}]);