<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前言 | 龙台技术笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/images/book.png">
    <link rel="manifest" href="/images/book.png">
    <link rel="apple-touch-icon" href="/images/book.png">
    <meta name="description" content="技术人写的技术笔记（工作总结）">
    <meta http-quiv="pragma" cotent="no-cache">
    <meta http-quiv="pragma" cotent="no-cache,must-revalidate">
    <meta http-quiv="expires" cotent="0">
    
    <link rel="preload" href="/assets/css/0.styles.84741abc.css" as="style"><link rel="preload" href="/assets/js/app.1b4c17a3.js" as="script"><link rel="preload" href="/assets/js/2.ad010850.js" as="script"><link rel="preload" href="/assets/js/45.f6c0a8dd.js" as="script"><link rel="prefetch" href="/assets/js/10.94d80ba6.js"><link rel="prefetch" href="/assets/js/11.2f420b54.js"><link rel="prefetch" href="/assets/js/12.780d4496.js"><link rel="prefetch" href="/assets/js/13.a5ec8293.js"><link rel="prefetch" href="/assets/js/14.22c75bd2.js"><link rel="prefetch" href="/assets/js/15.a6bc3bc3.js"><link rel="prefetch" href="/assets/js/16.40ca1c91.js"><link rel="prefetch" href="/assets/js/17.1ecdc880.js"><link rel="prefetch" href="/assets/js/18.f657f93c.js"><link rel="prefetch" href="/assets/js/19.76f9fefa.js"><link rel="prefetch" href="/assets/js/20.d7e54280.js"><link rel="prefetch" href="/assets/js/21.87a15fe3.js"><link rel="prefetch" href="/assets/js/22.35a749d4.js"><link rel="prefetch" href="/assets/js/23.dee18ee7.js"><link rel="prefetch" href="/assets/js/24.3179102b.js"><link rel="prefetch" href="/assets/js/25.f4debb1b.js"><link rel="prefetch" href="/assets/js/26.53e571d4.js"><link rel="prefetch" href="/assets/js/27.2649242b.js"><link rel="prefetch" href="/assets/js/28.bd7b7239.js"><link rel="prefetch" href="/assets/js/29.178488c4.js"><link rel="prefetch" href="/assets/js/3.f5671358.js"><link rel="prefetch" href="/assets/js/30.dba7fb10.js"><link rel="prefetch" href="/assets/js/31.321ab434.js"><link rel="prefetch" href="/assets/js/32.12e9a817.js"><link rel="prefetch" href="/assets/js/33.1efba5ba.js"><link rel="prefetch" href="/assets/js/34.e5d5831c.js"><link rel="prefetch" href="/assets/js/35.1ae0fc93.js"><link rel="prefetch" href="/assets/js/36.4d65b835.js"><link rel="prefetch" href="/assets/js/37.6a50545e.js"><link rel="prefetch" href="/assets/js/38.d78bb435.js"><link rel="prefetch" href="/assets/js/39.706e6b6c.js"><link rel="prefetch" href="/assets/js/4.52188786.js"><link rel="prefetch" href="/assets/js/40.f2fd40f1.js"><link rel="prefetch" href="/assets/js/41.b5d516b6.js"><link rel="prefetch" href="/assets/js/42.b865b616.js"><link rel="prefetch" href="/assets/js/43.f9d76365.js"><link rel="prefetch" href="/assets/js/44.a77506c5.js"><link rel="prefetch" href="/assets/js/46.0ad618af.js"><link rel="prefetch" href="/assets/js/47.0079f20d.js"><link rel="prefetch" href="/assets/js/48.64c7ca11.js"><link rel="prefetch" href="/assets/js/49.43a22984.js"><link rel="prefetch" href="/assets/js/5.59fc555e.js"><link rel="prefetch" href="/assets/js/6.256d2fbb.js"><link rel="prefetch" href="/assets/js/7.0d1e400d.js"><link rel="prefetch" href="/assets/js/8.aab2d760.js"><link rel="prefetch" href="/assets/js/9.902bae2f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.84741abc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">龙台技术笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/home/guide.html" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/db/" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/thread/" class="nav-link router-link-active">
  并发编程
</a></div><div class="nav-item"><a href="/frame/" class="nav-link">
  框架知识
</a></div><div class="nav-item"><a href="/design/" class="nav-link">
  代码设计
</a></div><div class="nav-item"><a href="/bug/" class="nav-link">
  BUG 专栏
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title">其它</span> <span class="arrow down"></span></button> <button type="button" aria-label="其它" class="mobile-dropdown-title"><span class="title">其它</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  动态线程池
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://house.machen.me" target="_blank" rel="noopener noreferrer" class="nav-link external">
  买房实践
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/home/guide.html" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/db/" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/thread/" class="nav-link router-link-active">
  并发编程
</a></div><div class="nav-item"><a href="/frame/" class="nav-link">
  框架知识
</a></div><div class="nav-item"><a href="/design/" class="nav-link">
  代码设计
</a></div><div class="nav-item"><a href="/bug/" class="nav-link">
  BUG 专栏
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title">其它</span> <span class="arrow down"></span></button> <button type="button" aria-label="其它" class="mobile-dropdown-title"><span class="title">其它</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  动态线程池
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://house.machen.me" target="_blank" rel="noopener noreferrer" class="nav-link external">
  买房实践
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前言</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/thread/%E7%BB%86%E6%95%B0%E4%B8%8D%E5%90%8C%E6%96%B9%E5%BC%8FRedis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/thread/%E7%BB%86%E6%95%B0%E4%B8%8D%E5%90%8C%E6%96%B9%E5%BC%8FRedis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86.html#分布式锁场景" class="sidebar-link">分布式锁场景</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/thread/%E7%BB%86%E6%95%B0%E4%B8%8D%E5%90%8C%E6%96%B9%E5%BC%8FRedis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86.html#jvm-锁" class="sidebar-link">JVM 锁</a></li></ul></li><li><a href="/thread/%E7%BB%86%E6%95%B0%E4%B8%8D%E5%90%8C%E6%96%B9%E5%BC%8FRedis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86.html#分布式锁" class="sidebar-link">分布式锁</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/thread/%E7%BB%86%E6%95%B0%E4%B8%8D%E5%90%8C%E6%96%B9%E5%BC%8FRedis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86.html#分布式锁演进史" class="sidebar-link">分布式锁演进史</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/thread/%E7%BB%86%E6%95%B0%E4%B8%8D%E5%90%8C%E6%96%B9%E5%BC%8FRedis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86.html#第一版-setnx" class="sidebar-link">第一版 setnx</a></li><li class="sidebar-sub-header"><a href="/thread/%E7%BB%86%E6%95%B0%E4%B8%8D%E5%90%8C%E6%96%B9%E5%BC%8FRedis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86.html#第二版-expire" class="sidebar-link">第二版 expire</a></li><li class="sidebar-sub-header"><a href="/thread/%E7%BB%86%E6%95%B0%E4%B8%8D%E5%90%8C%E6%96%B9%E5%BC%8FRedis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86.html#第三版-set" class="sidebar-link">第三版 set</a></li><li class="sidebar-sub-header"><a href="/thread/%E7%BB%86%E6%95%B0%E4%B8%8D%E5%90%8C%E6%96%B9%E5%BC%8FRedis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86.html#第四版-verify-value" class="sidebar-link">第四版 verify value</a></li><li class="sidebar-sub-header"><a href="/thread/%E7%BB%86%E6%95%B0%E4%B8%8D%E5%90%8C%E6%96%B9%E5%BC%8FRedis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86.html#第五版-lua" class="sidebar-link">第五版 lua</a></li></ul></li><li><a href="/thread/%E7%BB%86%E6%95%B0%E4%B8%8D%E5%90%8C%E6%96%B9%E5%BC%8FRedis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86.html#todo-列表" class="sidebar-link">TODO 列表</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/thread/%E7%BB%86%E6%95%B0%E4%B8%8D%E5%90%8C%E6%96%B9%E5%BC%8FRedis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86.html#文末总结" class="sidebar-link">文末总结</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>分布式锁相信大家一定不会陌生, 想要用好或者自己写一个却没那么简单</p> <p>想要达到上述的条件, 一定要 <strong>掌握分布式锁的应用场景</strong>, 以及分布式锁的不同实现, 不同实现之间有什么区别</p> <h2 id="分布式锁场景"><a href="#分布式锁场景" class="header-anchor">#</a> 分布式锁场景</h2> <p>如果想真正了解分布式锁, 需要结合一定场景; 举个例子, 某夕夕上抢购 AirPods Pro 的 100 元优惠券</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20200921095428315.png" alt=""></p> <p>如果使用下面这段代码当作抢购优惠券的后台程序, 我们一起看一下, 可能存在什么样的问题</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/%E4%BC%98%E6%83%A0%E5%88%B8%E6%8A%A2%E8%B4%AD.png" alt=""></p> <p>很明显的就是这段流程在并发场景下并不安全, 会导致优惠券发放超过预期, 类似电商抢购超卖问题</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/%E6%83%B3%E6%83%B3%E5%B0%B1%E6%BF%80%E5%8A%A8.jpg" alt=""></p> <p>想一哈有什么方式可以避免这种分布式下超量问题?</p> <p><strong>互斥加锁</strong>, Java 中互斥锁的语义就是 <strong>同一时间, 只允许一个客户端对资源进行操作</strong></p> <p>比如 Java 中的关键字 <strong>Synchronized</strong>, 以及 JUC Lock 包下的 ReentrantLock 都可以实现互斥锁</p> <h3 id="jvm-锁"><a href="#jvm-锁" class="header-anchor">#</a> JVM 锁</h3> <p>如图所示, 加入 JVM synchronized 锁确实可以解决单机下并发问题</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/synchronized.png" alt=""></p> <p>但是生产环境为了保证服务高可用, 起码要 <strong>部署两台服务</strong>, 这样的话 synchronized 就不起作用了, 因为它的 <strong>作用域只是单个 JVM</strong></p> <p>分布式情况下只能通过 <strong>分布式锁</strong> 来解决多个服务资源共享的问题了</p> <blockquote><p>如果死磕单服务, 那没的说, 分布式锁就是浮云 ☁️</p></blockquote> <h2 id="分布式锁"><a href="#分布式锁" class="header-anchor">#</a> 分布式锁</h2> <p>分布式锁的定义:</p> <blockquote><p><strong>保证同一时间只能有一个客户端对共享资源进行操作</strong></p></blockquote> <p>比对刚才举的例子, 不论部署多少台优惠券服务, 只会有 <strong>一台服务能够对优惠券数量进行增删操作</strong></p> <p>另外有几点要求也是必须要满足的:</p> <p>1、**不会发生死锁。**即使有一个客户端在持有锁的期间崩溃而没有主动解锁，也能保证后续其他客户端能加锁</p> <p>2、**具有容错性。**只要大部分的Redis节点正常运行，客户端就可以加锁和解锁</p> <p>3、**解铃还须系铃人。**加锁和解锁必须是同一个客户端，客户端自己不能把别人加的锁给解了</p> <p>分布式锁实现大致分为三种, Redis、Zookeeper、数据库, 文章以 Redis 展开分布式锁的讨论</p> <h2 id="分布式锁演进史"><a href="#分布式锁演进史" class="header-anchor">#</a> 分布式锁演进史</h2> <p>先来构思下分布式锁实现思路</p> <p>首先我们必须保证同一时间只有一个客户端(部署的优惠券服务)操作数量加减</p> <p>其次本次 <strong>客户端操作完成后</strong>, 需要让 <strong>其它客户端继续执行</strong></p> <p>1、客户端一存放一个标志位, 如果添加成功, 操作减优惠券数量操作</p> <p>2、客户端二添加标志位失败, 本次减库存操作失败(或继续尝试获取等)</p> <p>3、客户端一优惠券操作完成后, 需要将标志位释放, 以便其余客户端对库存进行操作</p> <h3 id="第一版-setnx"><a href="#第一版-setnx" class="header-anchor">#</a> 第一版 setnx</h3> <p>向 Redis 中添加一个 lockKey 锁标志位, 如果添加成功则能够继续向下执行扣减优惠券数量操作, 最后再释放此标志位</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/setIfAbsent.png" alt=""></p> <p>由于使用的是 Spring 提供的 Redis 封装的 Start 包, 所有有些命令与 Redis 原生命令不相符</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">setnx</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>加了简单的几行代码, 一个简单的分布式锁的雏形就出来了</p> <h3 id="第二版-expire"><a href="#第二版-expire" class="header-anchor">#</a> 第二版 expire</h3> <p>上面第一版基于 setnx 命令实现分布式锁的缺陷也是很明显的, 那就是 <strong>一定情况下可能发生死锁</strong></p> <p>画个图, 举个例子说明哈</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201121112507681.png" alt=""></p> <p>上图说明, 线程1在成功获取锁后, 执行流程时异常结束, <strong>没有执行释放锁操作</strong>, 这样就会 <strong>产生死锁</strong></p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/%E5%88%BA%E6%BF%80.jpg" alt=""></p> <p>如果方法执行异常导致的线程被回收, 那么可以将解锁操作放到 finally 块中</p> <p>但是还有存在死锁问题, <strong>如果获得锁的线程在执行中, 服务被强制停止或服务器宕机, 锁依然不会得到释放</strong></p> <p>这种极端情况下我们还是要考虑的, 毕竟不能只想着服务没问题对吧</p> <p>对 Redis 的 <strong>锁标志位加上过期时间</strong> 就能很好的防止死锁问题, 继续更改下程序代码</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/expire.png" alt=""></p> <p>虽然 <strong>小红旗处</strong> 对分布式锁添加了过期时间, 但依然无法避免极端情况下的死锁问题</p> <p><strong>那就是如果在客户端加锁成功后, 还没有设置过期时间时宕机</strong></p> <p>如果想要避免添加锁时死锁, 那就对添加锁标志位 &amp; 添加过期时间命令 <strong>保证一个原子性, 要么一起成功, 要么一起失败</strong></p> <h3 id="第三版-set"><a href="#第三版-set" class="header-anchor">#</a> 第三版 set</h3> <p>我们的添加锁原子命令就要登场了, 从 Redis 2.6.12 版本起, 提供了可选的 <strong>字符串 set 复合命令</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>SET key value <span class="token punctuation">[</span>expiration EX seconds<span class="token operator">|</span>PX milliseconds<span class="token punctuation">]</span> <span class="token punctuation">[</span>NX<span class="token operator">|</span>XX<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可选参数如下:</p> <ul><li><strong>EX:</strong> 设置超时时间，单位是秒</li> <li><strong>PX:</strong> 设置超时时间，单位是毫秒</li> <li><strong>NX:</strong> IF NOT EXIST 的缩写，只有 <strong>KEY不存在的前提下</strong> 才会设置值</li> <li><strong>XX:</strong> IF EXIST 的缩写，只有在 <strong>KEY存在的前提下</strong> 才会设置值</li></ul> <p>继续完善分布式锁的应用程序, 代码如下:</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/jedis_set.png" alt=""></p> <p>我使用的 <strong>2.0.9.RELEASE</strong> 版本的 SpringBoot, RedisTemplate 中不支持 set 复合命令, 所以临时换个 Jedis 来实现</p> <p><strong>加锁以及设置过期时间确实保证了原子性, 但是这样的分布式锁就没有问题了么?</strong></p> <p>我们根据图片以及流程描述设想一下这个场景</p> <p>1、线程一获取锁成功, 设置过期时间五秒, 接着执行业务逻辑</p> <p>2、接着线程一获取锁后执行业务流程, 执行的时间超过了过期时间, 锁标志位过期进行释放, 此时线程二获取锁成功</p> <p>3、然鹅此时线程一执行完业务后, 开始执行释放锁的流程, 然后顺手就把线程二获取的锁释放了</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/%E6%88%91%E5%95%A5%E4%B9%9F%E6%B2%A1%E5%B9%B2.jpg" alt=""></p> <p>如果线上真的发生上述问题, 那真的是xxx, 更甚者可能存在线程一将线程二的锁释放掉之后, 线程三获取到锁, 然后线程二执行完将线程三的锁释放</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/%E8%A1%8C%E4%BA%86%E8%A1%8C%E4%BA%86.jpg" alt=""></p> <h3 id="第四版-verify-value"><a href="#第四版-verify-value" class="header-anchor">#</a> 第四版 verify value</h3> <p>事当如今, 只能创建辨别客户端身份的唯一值了, 将加锁及解锁归一化, 上代码~</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/verify_value.png" alt=""></p> <p>这一版的代码相当于我们添加锁标志位时, 同时为每个客户端设置了 uuid 作为锁标志位的 val, 解锁时需要判断锁的 val 是否和自己客户端的相同, 辨别成功才会释放锁</p> <p>但是上述代码执行业务逻辑如果抛出异常, 锁只能等待过期时间, 我们可以将解锁操作放到 finally 块</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/finally_del.png" alt=""></p> <p>大眼一看, 上上下下实现了四版分布式锁, 也该没问题了吧</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/%E5%A4%AA%E5%B9%B4%E8%BD%BB.jpg" alt=""></p> <p>真相就是: 解锁时,  <strong>由于判断锁和删除标志位并不是原子性的, 所以可能还是会存在误删</strong></p> <p>1、线程一获取锁后, 执行流程balabala... 判断锁也是自家的, 这时 CPU 转头去做别的事情了, 恰巧线程一的锁过期时间到了</p> <p>2、线程二此时顺理成章的获取到了分布式锁, 执行业务逻辑balabala...</p> <p>3、线程一再次分配到时间片继续执行删除操作</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/%E6%83%8A%E5%96%9C%E6%84%8F%E5%A4%96.jpg" alt=""></p> <p>解决这种非原子操作的方式只能 <strong>将判断元素值和删除标志位当作一个原子操作</strong></p> <h3 id="第五版-lua"><a href="#第五版-lua" class="header-anchor">#</a> 第五版 lua</h3> <p>很不友好的是, del 删除操作并没有提供原子命令, 所以我们需要想点办法</p> <p>Redis在 2.6 推出了脚本功能, 允许开发者使用 Lua 语言编写脚本传到 Redis 中执行</p> <p>使用 Lua 脚本有什么好处呢?</p> <p><strong>1、减少网络开销</strong></p> <p>原本我们需要向 Redis 服务请求多次命令, 可以将命令写在 Lua 脚本中, 这样执行只会发起一次网络请求</p> <p><strong>2、原子操作</strong></p> <p>Redis 会将 Lua 脚本中的命令当作一个整体执行, 中间不会插入其它命令</p> <p><strong>3、复用(大家自己探索哈)</strong></p> <p>客户端发送的脚步会存储 Redis 中, 其他客户端可以复用这一脚本而不需要使用代码完成相同的逻辑</p> <p>那我们编写一个简单的 Lua 脚本实现原子删除操作</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/lua_atom.png" alt=""></p> <p>重点就在 Lua 脚本这一块, 重点说一下这块的逻辑</p> <p>script 脚本就是我们在 Redis 中执行的 Lua 脚本, 后面跟的两个 List 分别是 KEYS、ARGV</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>cache<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>lockValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>KEYS[1]:</strong> lockKey</p> <p><strong>ARGV[1]:</strong> lockValue</p> <p>代码不是很多, 也比较简单, 就是在 Java 中代码实现的逻辑放到了一个 Lua 脚本中</p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code><span class="token operator">#</span> 获取 KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> 对应的 Val
<span class="token keyword">local</span> cliVal <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">#</span> 判断 KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> 与 ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> 是否保持一致
<span class="token keyword">if</span><span class="token punctuation">(</span>cliVal <span class="token operator">==</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">then</span> 
  <span class="token operator">#</span> 删除 KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
  redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
  <span class="token keyword">return</span> <span class="token string">'OK'</span> 
<span class="token keyword">else</span>
  <span class="token keyword">return</span> <span class="token keyword">nil</span> 
<span class="token keyword">end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>到了这种程度, 已经可以放到一些并发量不大的项目中生产使用了</p> <h2 id="todo-列表"><a href="#todo-列表" class="header-anchor">#</a> TODO 列表</h2> <p>虽然上述代码已经很大程度上解决了分布式锁可能存在的一些问题</p> <p>但是下述列出的问题部分就不是客户端代码范畴内的事情了</p> <ul><li><p>如何实现可重入锁</p></li> <li><p>如何解决代码执行锁超时</p></li> <li><p>主从节点同步数据丢失导致锁丢失问题</p></li></ul> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/%E5%A5%BD%E9%9A%BE%E5%95%8A.jpg" alt=""></p> <p>上述问题等下一篇介绍 Redisson 源码时会一一说明, 顺道向大家推出一款 <strong>Redis 官方推荐的客户端: Redisson</strong></p> <p>Jedis... 等客户端平常使用是绰绰有余的, 但是在功能上还是和 Redisoon 比不了</p> <blockquote><p>并不是推荐一定要用 Redisson, 根据不同场景选用不同客户端</p></blockquote> <p>Redisson 就是为分布式提供 <strong>各种不同锁以及多样化的技术支持,</strong> 感兴趣的小伙伴可以看一下 Giuhub 上的介绍, 挺详细的</p> <p>下一篇文章会详细介绍 Redisson 分布式锁的加锁、解锁原理</p> <blockquote><p>看了 Redisson 的源码后简直了... 然后对之前项目的分布式锁做了重构, 在原有基础上增加了如下功能</p></blockquote> <ul><li>保证了加锁、解锁之间的原子性</li> <li>可重入的分布式锁</li> <li>分布式锁自动延期功能</li></ul> <h2 id="文末总结"><a href="#文末总结" class="header-anchor">#</a> 文末总结</h2> <p>本篇文章从最简单的分布式锁说起, 一步一步的讲述存在的问题以及解决方式, 最终得到个基本可用的分布式锁</p> <p>但是事无绝对, 对于分布式锁的应用, 还是推荐在 <strong>代码以及数据库表中添加兜底策略, 乐观锁等措施</strong></p> <p>另外向大家推荐了一款功能强大的 Redis 客户端, 感兴趣的小伙伴可以引入试下 😊</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1b4c17a3.js" defer></script><script src="/assets/js/2.ad010850.js" defer></script><script src="/assets/js/45.f6c0a8dd.js" defer></script>
  </body>
</html>
