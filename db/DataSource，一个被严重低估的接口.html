<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>文章产出背景 | 龙台技术笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/images/book.png">
    <link rel="manifest" href="/images/book.png">
    <link rel="apple-touch-icon" href="/images/book.png">
    <meta name="description" content="技术人写的技术笔记（工作总结）">
    <meta http-quiv="pragma" cotent="no-cache">
    <meta http-quiv="pragma" cotent="no-cache,must-revalidate">
    <meta http-quiv="expires" cotent="0">
    
    <link rel="preload" href="/assets/css/0.styles.56f8f03c.css" as="style"><link rel="preload" href="/assets/js/app.9f6db045.js" as="script"><link rel="preload" href="/assets/js/2.ad010850.js" as="script"><link rel="preload" href="/assets/js/11.05ca654e.js" as="script"><link rel="prefetch" href="/assets/js/10.cbffc92a.js"><link rel="prefetch" href="/assets/js/12.ad56d1ad.js"><link rel="prefetch" href="/assets/js/13.cbb68b5f.js"><link rel="prefetch" href="/assets/js/14.deb3efeb.js"><link rel="prefetch" href="/assets/js/15.4bd8d806.js"><link rel="prefetch" href="/assets/js/16.18544ac8.js"><link rel="prefetch" href="/assets/js/17.3d970734.js"><link rel="prefetch" href="/assets/js/18.24bdf351.js"><link rel="prefetch" href="/assets/js/19.20ee8468.js"><link rel="prefetch" href="/assets/js/20.76cc2f2f.js"><link rel="prefetch" href="/assets/js/21.a060d59a.js"><link rel="prefetch" href="/assets/js/22.8dd2c3cb.js"><link rel="prefetch" href="/assets/js/23.38503d1a.js"><link rel="prefetch" href="/assets/js/24.b5bab63e.js"><link rel="prefetch" href="/assets/js/25.f541c5de.js"><link rel="prefetch" href="/assets/js/26.ee0820ec.js"><link rel="prefetch" href="/assets/js/27.8e2f5fd3.js"><link rel="prefetch" href="/assets/js/28.b05c6b48.js"><link rel="prefetch" href="/assets/js/29.19cdc57c.js"><link rel="prefetch" href="/assets/js/3.d533eea8.js"><link rel="prefetch" href="/assets/js/30.98878ec6.js"><link rel="prefetch" href="/assets/js/31.572b5ab4.js"><link rel="prefetch" href="/assets/js/32.bce65027.js"><link rel="prefetch" href="/assets/js/33.37e89393.js"><link rel="prefetch" href="/assets/js/34.ba1a6fba.js"><link rel="prefetch" href="/assets/js/35.c7dd14b8.js"><link rel="prefetch" href="/assets/js/36.91b56d4a.js"><link rel="prefetch" href="/assets/js/37.818f9351.js"><link rel="prefetch" href="/assets/js/38.f7f3e6b0.js"><link rel="prefetch" href="/assets/js/39.4a1489dc.js"><link rel="prefetch" href="/assets/js/4.d52d5841.js"><link rel="prefetch" href="/assets/js/40.175dfc07.js"><link rel="prefetch" href="/assets/js/41.d75e30b9.js"><link rel="prefetch" href="/assets/js/42.dcfe80e6.js"><link rel="prefetch" href="/assets/js/43.4669e03d.js"><link rel="prefetch" href="/assets/js/44.5b6aa46b.js"><link rel="prefetch" href="/assets/js/5.8c9ed1e9.js"><link rel="prefetch" href="/assets/js/6.256d2fbb.js"><link rel="prefetch" href="/assets/js/7.26cc56f0.js"><link rel="prefetch" href="/assets/js/8.d0a0d91a.js"><link rel="prefetch" href="/assets/js/9.272d66c4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.56f8f03c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">龙台技术笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/db/" class="nav-link router-link-active">
  数据库
</a></div><div class="nav-item"><a href="/thread/" class="nav-link">
  并发编程
</a></div><div class="nav-item"><a href="/frame/" class="nav-link">
  框架知识
</a></div><div class="nav-item"><a href="/design/" class="nav-link">
  代码设计
</a></div><div class="nav-item"><a href="/bug/" class="nav-link">
  BUG 专栏
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title">其它</span> <span class="arrow down"></span></button> <button type="button" aria-label="其它" class="mobile-dropdown-title"><span class="title">其它</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  动态线程池
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/acmenlt/House-Notes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  买房实践
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/db/" class="nav-link router-link-active">
  数据库
</a></div><div class="nav-item"><a href="/thread/" class="nav-link">
  并发编程
</a></div><div class="nav-item"><a href="/frame/" class="nav-link">
  框架知识
</a></div><div class="nav-item"><a href="/design/" class="nav-link">
  代码设计
</a></div><div class="nav-item"><a href="/bug/" class="nav-link">
  BUG 专栏
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title">其它</span> <span class="arrow down"></span></button> <button type="button" aria-label="其它" class="mobile-dropdown-title"><span class="title">其它</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  动态线程池
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/acmenlt/House-Notes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  买房实践
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>文章产出背景</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/db/DataSource%EF%BC%8C%E4%B8%80%E4%B8%AA%E8%A2%AB%E4%B8%A5%E9%87%8D%E4%BD%8E%E4%BC%B0%E7%9A%84%E6%8E%A5%E5%8F%A3.html#文章产出背景" class="sidebar-link">文章产出背景</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/db/DataSource%EF%BC%8C%E4%B8%80%E4%B8%AA%E8%A2%AB%E4%B8%A5%E9%87%8D%E4%BD%8E%E4%BC%B0%E7%9A%84%E6%8E%A5%E5%8F%A3.html#老时代的数据查询" class="sidebar-link">老时代的数据查询</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/db/DataSource%EF%BC%8C%E4%B8%80%E4%B8%AA%E8%A2%AB%E4%B8%A5%E9%87%8D%E4%BD%8E%E4%BC%B0%E7%9A%84%E6%8E%A5%E5%8F%A3.html#连接池的出现" class="sidebar-link">连接池的出现</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/db/DataSource%EF%BC%8C%E4%B8%80%E4%B8%AA%E8%A2%AB%E4%B8%A5%E9%87%8D%E4%BD%8E%E4%BC%B0%E7%9A%84%E6%8E%A5%E5%8F%A3.html#数据源登场" class="sidebar-link">数据源登场</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/db/DataSource%EF%BC%8C%E4%B8%80%E4%B8%AA%E8%A2%AB%E4%B8%A5%E9%87%8D%E4%BD%8E%E4%BC%B0%E7%9A%84%E6%8E%A5%E5%8F%A3.html#datasource-技术解析" class="sidebar-link">DataSource 技术解析</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/db/DataSource%EF%BC%8C%E4%B8%80%E4%B8%AA%E8%A2%AB%E4%B8%A5%E9%87%8D%E4%BD%8E%E4%BC%B0%E7%9A%84%E6%8E%A5%E5%8F%A3.html#完事总结" class="sidebar-link">完事总结</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="文章产出背景"><a href="#文章产出背景" class="header-anchor">#</a> 文章产出背景</h2> <p>代码不多，文章不长，简要描述了下 DataSource 演进过程的故事</p> <p>最近这段时间一直忙着集团内部安全等保加密相关事项，初步决定使用 shardingsphere 来进行</p> <p>因为项目众多，需要兼容的需求也随之而来，加密数据源和动态数据源的互相兼容，以及分库分表和加密数据源的兼容等等，反正一言不合就兼容</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/datasource-bq-%E5%A7%94%E5%B1%88.jpg" alt=""></p> <p>无疑，上面这些或多或少都和数据源有关系，所以在处理不同兼容性等问题时，也让我再次对 DataSource 产生了了解的兴趣，这个曾经被很多人遗忘的重要概念</p> <h2 id="老时代的数据查询"><a href="#老时代的数据查询" class="header-anchor">#</a> 老时代的数据查询</h2> <p>在很久很久以前（反正忘了多久），那个时候程序员连接数据库还是这么个操作</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/datasource-2.png" alt=""></p> <p>可以清楚的看到，曾经获取数据库连接的代码还需要使用 DriverManager，大家都清楚，<code>DriverManager#getConnection</code> 是通过数据库驱动直接与数据库建立连接</p> <p><font color="#FF0000">而建立数据库连接属于耗费时间的事情</font>，如果业务层每次进行 SQL 查询都使用此方式，将会产生较大的系统开销</p> <p>一般系统的性能要求，单次请求需要稳定在 200 ms。经过在本地环境测试，DriverManager 形式创建数据库连接需要 <strong>300~500 ms</strong> 左右，<strong>健身五分钟，拍照两小时？</strong></p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/datasource-%E8%80%81%E5%A4%A9%E7%88%B7.jpg" alt=""></p> <p>随着系统的发展迭代，出于 <strong>系统的复杂度以及对性能的要求</strong>，这种获取连接的方式是难以接受的</p> <h2 id="连接池的出现"><a href="#连接池的出现" class="header-anchor">#</a> 连接池的出现</h2> <p>相信有些读者能够联想出来，数据库连接创建消耗资源这个场景好像在哪听过，没错，和线程创建的情况基本类似。既然线程可以用线程池关联，<strong>那数据库连接是不是可以放到一个池子中？</strong></p> <p>是的，还真有存放数据库连接的池化技术，叫做 <strong>连接池</strong>。应用程序从连接池中获取数据库连接，<strong>使用过再放到池子里</strong>，是不是感觉很 Nice？完美的解决了重复创建消耗资源的情况</p> <p>看似完美的背后，其实还存在一个致命的问题，那就是最开始去连接池中获取连接时，连接池中是没有连接的，还需要走创建流程</p> <p>连接池是怎么解决这一问题呢？<strong>通过创建连接池时初始化其中的连接</strong>，一般连接池都有这样一个参数 <code>initialSize</code>，代表池子中初始化的连接数量</p> <p>下图是 Druid 在执行 init 方法时数据库连接初始化的流程，当初始化连接小于池内连接时，进行循环创建，直到池内连接满足初始化数量</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/datasource-4.png" alt=""></p> <p>连接池、线程池...这些池化技术的核心思想就是 <strong>空间换取时间</strong>。因为在绝大数情况下，空间并没有那么稀缺，我们更关心的是系统的性能</p> <h2 id="数据源登场"><a href="#数据源登场" class="header-anchor">#</a> 数据源登场</h2> <p>连接池虽然 🐂 🍺 ，但是独木难支，<strong>连接池没有产生连接的能力</strong>，所以还需要配合类似 DriverManager 组件与数据库驱动配合创建连接。如果这样放到业务代码里，那岂不是还得封装一层？</p> <p>这个时候，不约而同的想到一个公司，sun 公司是干啥的？制定规范的对不对，他们在 jdbc 2.0 版本推出一个 DataSource 的东东，<strong>用来进行规范约束</strong></p> <p>相当于把 DriverManager 和连接池概念揉合在一起，<strong>如果你想获取数据库连接，你通过我 DataSource 获取</strong>，你不用关心连接池和数据库连接怎么创建的，用就完了。其实，DataSource 获取的连接来自于连接池，而连接池的连接其实还是从 DriverManager或类似组件中创建的</p> <hr> <p><strong>DriverManager 只是 jdbc 1.0 版本用来调用数据库驱动的的工具包</strong>，jdbc 2.0 版本推出 DataSource 之后，典型的像 <strong>DruidDataSource 就没有依赖 DriverManager</strong>，而是在自己实现类中调用了数据库驱动。这里只是重点强调，<strong>数据库连接不一定是使用 DriverManager 创建</strong></p> <hr> <p>总结下，数据源（DataSource）是 sun 公司指定用于获取数据库连接的规范接口，应用程序于数据库连接抽象的中间层，它存在于 <code>javax.sql</code> 包，用来代替 DriverManager 的方式获取数据库连接</p> <h4 id="使用-datasource-比-drivermanager-到底有什么好处呢"><a href="#使用-datasource-比-drivermanager-到底有什么好处呢" class="header-anchor">#</a> 使用 DataSource 比 DriverManager 到底有什么好处呢</h4> <p><strong>DriverManager</strong></p> <ul><li><p>在应用程序里创建/关闭连接时会妨碍应用程序性能</p></li> <li><p>不支持连接池，重复创建/关闭连接，浪费系统性能</p></li></ul> <p><strong>DataSource</strong></p> <ul><li><p>由于不在应用程序中创建/关闭连接，可以很好的提高应用程序性能</p></li> <li><p>提供了连接池的功能，避免重复创建</p></li></ul> <p>这里画一张图来描述下，针对应用程序使用 DataSource 和 DriverManager 获取连接的不同</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210516123742062.png" alt=""></p> <p>有了 DataSource 之后，数据库连接、用户名、密码都进行了统一的管理，作为 DataSource 属性的一部分，并且将数据库驱动名称填充，底层自动加载</p> <h2 id="datasource-技术解析"><a href="#datasource-技术解析" class="header-anchor">#</a> DataSource 技术解析</h2> <p>我们先来看下 DataSource 的接口描述以及对应的方法，先初步进行了解</p> <p>DataSource 中只有两个接口，是一个重载的关系，用于建立 DataSource 所代表数据源的数据库连接</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/datasource-3.png" alt=""></p> <p>这里应该注意的是 <code>CommonDataSource</code> 接口，公共数据源接口用来定义以下三个数据源接口的公共方法</p> <ul><li><p>javax.sql.DataSource：定义基础获取数据库连接的接口</p></li> <li><p>javax.sql.ConnectionPoolDataSource：定义从数据库连接池中获取连接的接口</p></li> <li><p>javax.sql.XADataSource：定义获取分布式事务连接的接口。一般少有直接使用 XA 分布式事务，具体原因参考 <a href="https://mp.weixin.qq.com/s/_zhntxv07GEz9ktAKuj70Q" target="_blank" rel="noopener noreferrer">分布式 2PC、3PC 事务模型<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ul> <p>第一、二种就比较容易理解，sun 公司定义规范时，就是希望你 <strong>普通获取数据库连接使用 DataSource</strong>，<strong>数据源底层如果是连接池那么使用 ConnectionPoolDataSource</strong></p> <p>后面发展逐渐脱离了原本的轨道预期，比如 DruidDataSource 就同时实现了两者，类图如下</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210516130105185.png" alt=""></p> <p>其实这样也没啥事，DruidDataSource 一个类包装两种 DataSource 接口实现，这种方式对于使用者是无感知的</p> <h2 id="完事总结"><a href="#完事总结" class="header-anchor">#</a> 完事总结</h2> <p>文章使用循序渐进的方式，帮助大家梳理了一遍 DataSource 产出背景</p> <p>讲述了 jdbc 1.0 版本获取数据库连接的方式 DriverManager，发展到 2.0 后的 DataSource，以及其中引入的数据库连接池技术</p> <p>相信读者看完对 DataSource 应该有了更深入的了解，感兴趣的读者可以去研读 Hikari 和 Druid 实现的数据源，通过阅读源码的方式能够更好的理解 DataSource 设计思路</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9f6db045.js" defer></script><script src="/assets/js/2.ad010850.js" defer></script><script src="/assets/js/11.05ca654e.js" defer></script>
  </body>
</html>
