<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前言 | 龙台技术笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/images/book.png">
    <link rel="manifest" href="/images/book.png">
    <link rel="apple-touch-icon" href="/images/book.png">
    <meta name="description" content="技术人写的技术笔记（工作总结）">
    <meta http-quiv="pragma" cotent="no-cache">
    <meta http-quiv="pragma" cotent="no-cache,must-revalidate">
    <meta http-quiv="expires" cotent="0">
    
    <link rel="preload" href="/assets/css/0.styles.56f8f03c.css" as="style"><link rel="preload" href="/assets/js/app.9f6db045.js" as="script"><link rel="preload" href="/assets/js/2.ad010850.js" as="script"><link rel="preload" href="/assets/js/12.ad56d1ad.js" as="script"><link rel="prefetch" href="/assets/js/10.cbffc92a.js"><link rel="prefetch" href="/assets/js/11.05ca654e.js"><link rel="prefetch" href="/assets/js/13.cbb68b5f.js"><link rel="prefetch" href="/assets/js/14.deb3efeb.js"><link rel="prefetch" href="/assets/js/15.4bd8d806.js"><link rel="prefetch" href="/assets/js/16.18544ac8.js"><link rel="prefetch" href="/assets/js/17.3d970734.js"><link rel="prefetch" href="/assets/js/18.24bdf351.js"><link rel="prefetch" href="/assets/js/19.20ee8468.js"><link rel="prefetch" href="/assets/js/20.76cc2f2f.js"><link rel="prefetch" href="/assets/js/21.a060d59a.js"><link rel="prefetch" href="/assets/js/22.8dd2c3cb.js"><link rel="prefetch" href="/assets/js/23.38503d1a.js"><link rel="prefetch" href="/assets/js/24.b5bab63e.js"><link rel="prefetch" href="/assets/js/25.f541c5de.js"><link rel="prefetch" href="/assets/js/26.ee0820ec.js"><link rel="prefetch" href="/assets/js/27.8e2f5fd3.js"><link rel="prefetch" href="/assets/js/28.b05c6b48.js"><link rel="prefetch" href="/assets/js/29.19cdc57c.js"><link rel="prefetch" href="/assets/js/3.d533eea8.js"><link rel="prefetch" href="/assets/js/30.98878ec6.js"><link rel="prefetch" href="/assets/js/31.572b5ab4.js"><link rel="prefetch" href="/assets/js/32.bce65027.js"><link rel="prefetch" href="/assets/js/33.37e89393.js"><link rel="prefetch" href="/assets/js/34.ba1a6fba.js"><link rel="prefetch" href="/assets/js/35.c7dd14b8.js"><link rel="prefetch" href="/assets/js/36.91b56d4a.js"><link rel="prefetch" href="/assets/js/37.818f9351.js"><link rel="prefetch" href="/assets/js/38.f7f3e6b0.js"><link rel="prefetch" href="/assets/js/39.4a1489dc.js"><link rel="prefetch" href="/assets/js/4.d52d5841.js"><link rel="prefetch" href="/assets/js/40.175dfc07.js"><link rel="prefetch" href="/assets/js/41.d75e30b9.js"><link rel="prefetch" href="/assets/js/42.dcfe80e6.js"><link rel="prefetch" href="/assets/js/43.4669e03d.js"><link rel="prefetch" href="/assets/js/44.5b6aa46b.js"><link rel="prefetch" href="/assets/js/5.8c9ed1e9.js"><link rel="prefetch" href="/assets/js/6.256d2fbb.js"><link rel="prefetch" href="/assets/js/7.26cc56f0.js"><link rel="prefetch" href="/assets/js/8.d0a0d91a.js"><link rel="prefetch" href="/assets/js/9.272d66c4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.56f8f03c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">龙台技术笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/db/" class="nav-link router-link-active">
  数据库
</a></div><div class="nav-item"><a href="/thread/" class="nav-link">
  并发编程
</a></div><div class="nav-item"><a href="/frame/" class="nav-link">
  框架知识
</a></div><div class="nav-item"><a href="/design/" class="nav-link">
  代码设计
</a></div><div class="nav-item"><a href="/bug/" class="nav-link">
  BUG 专栏
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title">其它</span> <span class="arrow down"></span></button> <button type="button" aria-label="其它" class="mobile-dropdown-title"><span class="title">其它</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  动态线程池
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/acmenlt/House-Notes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  买房实践
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/db/" class="nav-link router-link-active">
  数据库
</a></div><div class="nav-item"><a href="/thread/" class="nav-link">
  并发编程
</a></div><div class="nav-item"><a href="/frame/" class="nav-link">
  框架知识
</a></div><div class="nav-item"><a href="/design/" class="nav-link">
  代码设计
</a></div><div class="nav-item"><a href="/bug/" class="nav-link">
  BUG 专栏
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title">其它</span> <span class="arrow down"></span></button> <button type="button" aria-label="其它" class="mobile-dropdown-title"><span class="title">其它</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  动态线程池
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/acmenlt/House-Notes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  买房实践
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前言</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/db/MySQL%E5%8D%83%E4%B8%87%E6%95%B0%E6%8D%AE%E6%B7%B1%E5%88%86%E9%A1%B5%E4%BC%98%E5%8C%96%EF%BC%8C%E6%8B%92%E7%BB%9D%E7%BA%BF%E4%B8%8A%E6%95%85%E9%9A%9C.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/db/MySQL%E5%8D%83%E4%B8%87%E6%95%B0%E6%8D%AE%E6%B7%B1%E5%88%86%E9%A1%B5%E4%BC%98%E5%8C%96%EF%BC%8C%E6%8B%92%E7%BB%9D%E7%BA%BF%E4%B8%8A%E6%95%85%E9%9A%9C.html#软硬件说明" class="sidebar-link">软硬件说明</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/db/MySQL%E5%8D%83%E4%B8%87%E6%95%B0%E6%8D%AE%E6%B7%B1%E5%88%86%E9%A1%B5%E4%BC%98%E5%8C%96%EF%BC%8C%E6%8B%92%E7%BB%9D%E7%BA%BF%E4%B8%8A%E6%95%85%E9%9A%9C.html#重新认识-mysql-分页" class="sidebar-link">重新认识 MySQL 分页</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/db/MySQL%E5%8D%83%E4%B8%87%E6%95%B0%E6%8D%AE%E6%B7%B1%E5%88%86%E9%A1%B5%E4%BC%98%E5%8C%96%EF%BC%8C%E6%8B%92%E7%BB%9D%E7%BA%BF%E4%B8%8A%E6%95%85%E9%9A%9C.html#深分页优化" class="sidebar-link">深分页优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/db/MySQL%E5%8D%83%E4%B8%87%E6%95%B0%E6%8D%AE%E6%B7%B1%E5%88%86%E9%A1%B5%E4%BC%98%E5%8C%96%EF%BC%8C%E6%8B%92%E7%BB%9D%E7%BA%BF%E4%B8%8A%E6%95%85%E9%9A%9C.html#子查询优化" class="sidebar-link">子查询优化</a></li><li class="sidebar-sub-header"><a href="/db/MySQL%E5%8D%83%E4%B8%87%E6%95%B0%E6%8D%AE%E6%B7%B1%E5%88%86%E9%A1%B5%E4%BC%98%E5%8C%96%EF%BC%8C%E6%8B%92%E7%BB%9D%E7%BA%BF%E4%B8%8A%E6%95%85%E9%9A%9C.html#延迟关联" class="sidebar-link">延迟关联</a></li><li class="sidebar-sub-header"><a href="/db/MySQL%E5%8D%83%E4%B8%87%E6%95%B0%E6%8D%AE%E6%B7%B1%E5%88%86%E9%A1%B5%E4%BC%98%E5%8C%96%EF%BC%8C%E6%8B%92%E7%BB%9D%E7%BA%BF%E4%B8%8A%E6%95%85%E9%9A%9C.html#书签记录" class="sidebar-link">书签记录</a></li></ul></li><li><a href="/db/MySQL%E5%8D%83%E4%B8%87%E6%95%B0%E6%8D%AE%E6%B7%B1%E5%88%86%E9%A1%B5%E4%BC%98%E5%8C%96%EF%BC%8C%E6%8B%92%E7%BB%9D%E7%BA%BF%E4%B8%8A%E6%95%85%E9%9A%9C.html#order-by-巨坑-慎踩" class="sidebar-link">ORDER BY 巨坑, 慎踩</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/db/MySQL%E5%8D%83%E4%B8%87%E6%95%B0%E6%8D%AE%E6%B7%B1%E5%88%86%E9%A1%B5%E4%BC%98%E5%8C%96%EF%BC%8C%E6%8B%92%E7%BB%9D%E7%BA%BF%E4%B8%8A%E6%95%85%E9%9A%9C.html#结言" class="sidebar-link">结言</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>优化项目代码过程中发现一个千万级数据深分页问题，缘由是这样的</p> <p>库里有一张耗材 MCS_PROD 表，<s>通过同步外部数据中台多维度数据，在系统内部组装为单一耗材产品</s>，最终同步到 ES 搜索引擎</p> <p>MySQL 同步 ES 流程如下：</p> <ol><li>通过定时任务的形式触发同步，比如间隔半天或一天的时间频率</li> <li>同步的形式为增量同步，根据更新时间的机制，比如第一次同步查询 &gt;= 1970-01-01 00:00:00.0</li> <li>记录最大的更新时间进行存储，下次更新同步以此为条件</li> <li>以分页的形式获取数据，当前页数量加一，循环到最后一页</li></ol> <p>在这里问题也就出现了，<strong>MySQL 查询分页 OFFSET 越深入，性能越差</strong>，初步估计线上 MCS_PROD 表中记录在 1000w 左右</p> <p>如果按照每页 10 条，OFFSET 值会拖垮查询性能，进而形成一个 <strong>&quot;性能深渊&quot;</strong></p> <p>同步类代码针对此问题有两种优化方式：</p> <ol><li><strong>采用游标、流式方案进行优化</strong></li> <li><strong>优化深分页性能，文章围绕这个题目展开</strong></li></ol> <blockquote><p>文章目录如下：</p> <ul><li>软硬件说明</li> <li>重新认识 MySQL 分页</li> <li>深分页优化
<ul><li>子查询优化</li> <li>延迟关联</li> <li>书签记录</li></ul></li> <li>ORDER BY 巨坑，慎踩
<ul><li>ORDER BY 索引失效举例</li></ul></li> <li>结言</li></ul></blockquote> <h2 id="软硬件说明"><a href="#软硬件说明" class="header-anchor">#</a> 软硬件说明</h2> <p><strong>MySQL VERSION</strong></p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> version<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------+</span>
<span class="token operator">|</span> version<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+</span>
<span class="token operator">|</span> <span class="token number">5.7</span><span class="token number">.30</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>表结构说明</strong></p> <p>借鉴公司表结构，字段、长度以及名称均已删减</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">DESC</span> MCS_PROD<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------------------+--------------+------+-----+---------+----------------+</span>
<span class="token operator">|</span> Field                 <span class="token operator">|</span> <span class="token keyword">Type</span>         <span class="token operator">|</span> <span class="token boolean">Null</span> <span class="token operator">|</span> <span class="token keyword">Key</span> <span class="token operator">|</span> <span class="token keyword">Default</span> <span class="token operator">|</span> Extra          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------------+--------------+------+-----+---------+----------------+</span>
<span class="token operator">|</span> MCS_PROD_ID           <span class="token operator">|</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>      <span class="token operator">|</span> <span class="token keyword">NO</span>   <span class="token operator">|</span> PRI <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token keyword">auto_increment</span> <span class="token operator">|</span>
<span class="token operator">|</span> MCS_CODE              <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span>         <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> MCS_NAME              <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span>         <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> UPDT_TIME             <span class="token operator">|</span> <span class="token keyword">datetime</span>     <span class="token operator">|</span> <span class="token keyword">NO</span>   <span class="token operator">|</span> MUL <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------------+--------------+------+-----+---------+----------------+</span>
<span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>通过测试同学帮忙造了 500w 左右数据量</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> MCS_PROD<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token operator">|</span>  <span class="token number">5100000</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">1.43</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>SQL 语句如下</strong></p> <p>因为功能需要满足 <strong>增量拉取的方式</strong>，所以会有数据更新时间的条件查询，以及相关 <strong>查询排序（此处有坑）</strong></p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span>
	MCS_PROD_ID<span class="token punctuation">,</span>
	MCS_CODE<span class="token punctuation">,</span>
	MCS_NAME<span class="token punctuation">,</span>
	UPDT_TIME
<span class="token keyword">FROM</span>
	MCS_PROD
<span class="token keyword">WHERE</span>
	UPDT_TIME <span class="token operator">&gt;=</span> <span class="token string">'1970-01-01 00:00:00.0'</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> UPDT_TIME
<span class="token keyword">LIMIT</span> xx<span class="token punctuation">,</span> xx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="重新认识-mysql-分页"><a href="#重新认识-mysql-分页" class="header-anchor">#</a> 重新认识 MySQL 分页</h2> <p>LIMIT 子句可以被用于强制 SELECT 语句返回指定的记录数。LIMIT 接收一个或两个数字参数，参数必须是一个整数常量</p> <p>如果给定两个参数，第一个参数指定第一个返回记录行的偏移量，第二个参数指定返回记录行的最大数</p> <p>举个简单的例子，分析下 SQL 查询过程，掌握深分页性能为什么差</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> MCS_PROD_ID<span class="token punctuation">,</span>MCS_CODE<span class="token punctuation">,</span>MCS_NAME <span class="token keyword">FROM</span> MCS_PROD <span class="token keyword">WHERE</span> <span class="token punctuation">(</span>UPDT_TIME <span class="token operator">&gt;=</span> <span class="token string">'1970-01-01 00:00:00.0'</span><span class="token punctuation">)</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> UPDT_TIME <span class="token keyword">LIMIT</span> <span class="token number">100000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------------+-------------------------+------------------+---------------------+</span>
<span class="token operator">|</span> MCS_PROD_ID <span class="token operator">|</span> MCS_CODE                <span class="token operator">|</span> MCS_NAME         <span class="token operator">|</span> UPDT_TIME           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+-------------------------+------------------+---------------------+</span>
<span class="token operator">|</span>      <span class="token number">181789</span> <span class="token operator">|</span> XA601709733186213015031 <span class="token operator">|</span> 尺、桡骨LC<span class="token operator">-</span>DCP骨板 <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">19</span> <span class="token number">16</span>:<span class="token number">22</span>:<span class="token number">19</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+-------------------------+------------------+---------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">3.66</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> MCS_PROD_ID<span class="token punctuation">,</span>MCS_CODE<span class="token punctuation">,</span>MCS_NAME <span class="token keyword">FROM</span> MCS_PROD <span class="token keyword">WHERE</span> <span class="token punctuation">(</span>UPDT_TIME <span class="token operator">&gt;=</span> <span class="token string">'1970-01-01 00:00:00.0'</span><span class="token punctuation">)</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> UPDT_TIME <span class="token keyword">LIMIT</span> <span class="token number">100000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+----------+------------+-------+---------------+------------+---------+------+---------+----------+-----------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>    <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>        <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>    <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+----------+------------+-------+---------------+------------+---------+------+---------+----------+-----------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> MCS_PROD <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range <span class="token operator">|</span> MCS_PROD_1    <span class="token operator">|</span> MCS_PROD_1 <span class="token operator">|</span> <span class="token number">5</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">2296653</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> condition <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+----------+------------+-------+---------------+------------+---------+------+---------+----------+-----------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>简单说明下上面 SQL 执行过程：</p> <ol><li>首先查询了表 MCS_PROD，进行过滤 UPDT_TIME 条件，查询出展示列（涉及回表操作）进行排序以及 LIMIT</li> <li>LIMIT 100000, 1 的意思是扫描满足条件的 100001 行，<strong>然后扔掉前 100000 行</strong></li></ol> <p>MySQL 耗费了 <strong>大量随机 I/O 在回表查询聚簇索引的数据上</strong>，而这 100000 次随机 I/O 查询数据不会出现在结果集中</p> <p>如果系统并发量稍微高一点，每次查询扫描超过 100000 行，性能肯定堪忧，另外 <strong>LIMIT 分页 OFFSET 越深，性能越差（多次强调）</strong></p> <p><img src="https://imagES-machen.oss-cn-beijing.aliyuncs.com/image-20201223204520344.png" alt="图1 数据仅供参考"></p> <h2 id="深分页优化"><a href="#深分页优化" class="header-anchor">#</a> 深分页优化</h2> <p>关于 MySQL 深分页优化常见的大概有以下三种策略：</p> <ol><li>子查询优化</li> <li>延迟关联</li> <li>书签记录</li></ol> <p>上面三点都能大大的提升查询效率，<strong>核心思想就是让 MySQL 尽可能扫描更少的页面</strong>，获取需要访问的记录后再根据关联列回原表查询所需要的列</p> <h3 id="子查询优化"><a href="#子查询优化" class="header-anchor">#</a> 子查询优化</h3> <p>子查询深分页优化语句如下：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> MCS_PROD_ID<span class="token punctuation">,</span>MCS_CODE<span class="token punctuation">,</span>MCS_NAME <span class="token keyword">FROM</span> MCS_PROD <span class="token keyword">WHERE</span> MCS_PROD_ID <span class="token operator">&gt;=</span> <span class="token punctuation">(</span> <span class="token keyword">SELECT</span> m1<span class="token punctuation">.</span>MCS_PROD_ID <span class="token keyword">FROM</span> MCS_PROD m1 <span class="token keyword">WHERE</span> m1<span class="token punctuation">.</span>UPDT_TIME <span class="token operator">&gt;=</span> <span class="token string">'1970-01-01 00:00:00.0'</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> m1<span class="token punctuation">.</span>UPDT_TIME <span class="token keyword">LIMIT</span> <span class="token number">3000000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">LIMIT</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------------+-------------------------+------------------------+</span>
<span class="token operator">|</span> MCS_PROD_ID <span class="token operator">|</span> MCS_CODE                <span class="token operator">|</span> MCS_NAME               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+-------------------------+------------------------+</span>
<span class="token operator">|</span>     <span class="token number">3021401</span> <span class="token operator">|</span> XA892010009391491861476 <span class="token operator">|</span> 金属解剖型接骨板T型接骨板A <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+-------------------------+------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.76</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> MCS_PROD_ID<span class="token punctuation">,</span>MCS_CODE<span class="token punctuation">,</span>MCS_NAME <span class="token keyword">FROM</span> MCS_PROD <span class="token keyword">WHERE</span> MCS_PROD_ID <span class="token operator">&gt;=</span> <span class="token punctuation">(</span> <span class="token keyword">SELECT</span> m1<span class="token punctuation">.</span>MCS_PROD_ID <span class="token keyword">FROM</span> MCS_PROD m1 <span class="token keyword">WHERE</span> m1<span class="token punctuation">.</span>UPDT_TIME <span class="token operator">&gt;=</span> <span class="token string">'1970-01-01 00:00:00.0'</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> m1<span class="token punctuation">.</span>UPDT_TIME <span class="token keyword">LIMIT</span> <span class="token number">3000000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">LIMIT</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+----------+------------+-------+---------------+------------+---------+------+---------+----------+--------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>    <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>        <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>    <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+----------+------------+-------+---------------+------------+---------+------+---------+----------+--------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> MCS_PROD <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>    <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">2296653</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span>              <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> SUBQUERY    <span class="token operator">|</span> m1       <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range <span class="token operator">|</span> MCS_PROD_1    <span class="token operator">|</span> MCS_PROD_1 <span class="token operator">|</span> <span class="token number">5</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">2296653</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+----------+------------+-------+---------------+------------+---------+------+---------+----------+--------------------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.77</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>根据执行计划得知，子查询 table m1 查询是用到了索引。首先在 <strong>索引上拿到了聚集索引的主键 ID 省去了回表操作</strong>，然后第二查询直接根据第一个查询的 ID 往后再去查 10 个就可以了</p> <p><img src="https://imagES-machen.oss-cn-beijing.aliyuncs.com/image-20201223205050818.png" alt="图2 数据仅供参考"></p> <h3 id="延迟关联"><a href="#延迟关联" class="header-anchor">#</a> 延迟关联</h3> <p>&quot;延迟关联&quot; 深分页优化语句如下：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> MCS_PROD_ID<span class="token punctuation">,</span>MCS_CODE<span class="token punctuation">,</span>MCS_NAME <span class="token keyword">FROM</span> MCS_PROD <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> m1<span class="token punctuation">.</span>MCS_PROD_ID <span class="token keyword">FROM</span> MCS_PROD m1 <span class="token keyword">WHERE</span> m1<span class="token punctuation">.</span>UPDT_TIME <span class="token operator">&gt;=</span> <span class="token string">'1970-01-01 00:00:00.0'</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> m1<span class="token punctuation">.</span>UPDT_TIME <span class="token keyword">LIMIT</span> <span class="token number">3000000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">AS</span>  MCS_PROD2 <span class="token keyword">USING</span><span class="token punctuation">(</span>MCS_PROD_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------------+-------------------------+------------------------+</span>
<span class="token operator">|</span> MCS_PROD_ID <span class="token operator">|</span> MCS_CODE                <span class="token operator">|</span> MCS_NAME               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+-------------------------+------------------------+</span>
<span class="token operator">|</span>     <span class="token number">3021401</span> <span class="token operator">|</span> XA892010009391491861476 <span class="token operator">|</span> 金属解剖型接骨板T型接骨板A <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+-------------------------+------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.75</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> MCS_PROD_ID<span class="token punctuation">,</span>MCS_CODE<span class="token punctuation">,</span>MCS_NAME <span class="token keyword">FROM</span> MCS_PROD <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> m1<span class="token punctuation">.</span>MCS_PROD_ID <span class="token keyword">FROM</span> MCS_PROD m1 <span class="token keyword">WHERE</span> m1<span class="token punctuation">.</span>UPDT_TIME <span class="token operator">&gt;=</span> <span class="token string">'1970-01-01 00:00:00.0'</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> m1<span class="token punctuation">.</span>UPDT_TIME <span class="token keyword">LIMIT</span> <span class="token number">3000000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">AS</span>  MCS_PROD2 <span class="token keyword">USING</span><span class="token punctuation">(</span>MCS_PROD_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+--------+---------------+------------+---------+-----------------------+---------+----------+--------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>      <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>   <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>        <span class="token operator">|</span> key_len <span class="token operator">|</span> ref                   <span class="token operator">|</span> <span class="token keyword">rows</span>    <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+--------+---------------+------------+---------+-----------------------+---------+----------+--------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token operator">&lt;</span>derived2<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>                  <span class="token operator">|</span> <span class="token number">2296653</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>                     <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> MCS_PROD   <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> eq_ref <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>    <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> MCS_PROD2<span class="token punctuation">.</span>MCS_PROD_ID <span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>                     <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> DERIVED     <span class="token operator">|</span> m1         <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range  <span class="token operator">|</span> MCS_PROD_1    <span class="token operator">|</span> MCS_PROD_1 <span class="token operator">|</span> <span class="token number">5</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>                  <span class="token operator">|</span> <span class="token number">2296653</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+--------+---------------+------------+---------+-----------------------+---------+----------+--------------------------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>思路以及性能与子查询优化一致，只不过采用了 JOIN 的形式执行</p> <h3 id="书签记录"><a href="#书签记录" class="header-anchor">#</a> 书签记录</h3> <p>关于 LIMIT 深分页问题，核心在于 OFFSET 值，它会 <strong>导致 MySQL 扫描大量不需要的记录行然后抛弃掉</strong></p> <p>我们可以先使用书签 <strong>记录获取上次取数据的位置</strong>，下次就可以直接从该位置开始扫描，这样可以 <strong>避免使用 OFFEST</strong></p> <p>假设需要查询 3000000 行数据后的第 1 条记录，查询可以这么写</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> MCS_PROD_ID<span class="token punctuation">,</span>MCS_CODE<span class="token punctuation">,</span>MCS_NAME <span class="token keyword">FROM</span> MCS_PROD <span class="token keyword">WHERE</span> MCS_PROD_ID <span class="token operator">&lt;</span> <span class="token number">3000000</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> UPDT_TIME <span class="token keyword">LIMIT</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------------+-------------------------+---------------------------------+</span>
<span class="token operator">|</span> MCS_PROD_ID <span class="token operator">|</span> MCS_CODE                <span class="token operator">|</span> MCS_NAME                        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+-------------------------+---------------------------------+</span>
<span class="token operator">|</span>         <span class="token number">127</span> <span class="token operator">|</span> XA683240878449276581799 <span class="token operator">|</span> 股骨近端<span class="token operator">-</span><span class="token number">1</span>螺纹孔锁定板（纯钛）YJBL01 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+-------------------------+---------------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> MCS_PROD_ID<span class="token punctuation">,</span>MCS_CODE<span class="token punctuation">,</span>MCS_NAME <span class="token keyword">FROM</span> MCS_PROD <span class="token keyword">WHERE</span> MCS_PROD_ID <span class="token operator">&lt;</span> <span class="token number">3000000</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> UPDT_TIME <span class="token keyword">LIMIT</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+----------+------------+-------+---------------+------------+---------+------+------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>    <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>        <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+----------+------------+-------+---------------+------------+---------+------+------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> MCS_PROD <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> MCS_PROD_1 <span class="token operator">|</span> <span class="token number">5</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">50.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+----------+------------+-------+---------------+------------+---------+------+------+----------+-------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>好处是很明显的，查询速度超级快，<strong>性能都会稳定在毫秒级</strong>，从性能上考虑碾压其它方式</p> <p>不过这种方式局限性也比较大，需要一种类似连续自增的字段，以及业务所能包容的连续概念，视情况而定</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20201224145609132.png" alt=""></p> <p>上图是阿里云 OSS Bucket 桶内文件列表，大胆猜测是不是可以采用书签记录的形式完成</p> <h2 id="order-by-巨坑-慎踩"><a href="#order-by-巨坑-慎踩" class="header-anchor">#</a> ORDER BY 巨坑, 慎踩</h2> <p>以下言论可能会打破你对 order by 所有 <strong>美好 YY</strong></p> <p>先说结论吧，当 LIMIT OFFSET 过深时，会使 <strong>ORDER BY 普通索引失效</strong>（联合、唯一这些索引没有测试）</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> MCS_PROD_ID<span class="token punctuation">,</span>MCS_CODE<span class="token punctuation">,</span>MCS_NAME<span class="token punctuation">,</span>UPDT_TIME <span class="token keyword">FROM</span> MCS_PROD <span class="token keyword">WHERE</span> <span class="token punctuation">(</span>UPDT_TIME <span class="token operator">&gt;=</span> <span class="token string">'1970-01-01 00:00:00.0'</span><span class="token punctuation">)</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> UPDT_TIME <span class="token keyword">LIMIT</span> <span class="token number">100000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----+-------------+----------+------------+-------+---------------+------------+---------+------+---------+----------+-----------------------+| id | select_type | table    | partitions | type  | possible_keys | key        | key_len | ref  | rows    | filtered | Extra                 |+----+-------------+----------+------------+-------+---------------+------------+---------+------+---------+----------+-----------------------+|  1 | SIMPLE      | MCS_PROD | NULL       | range | MCS_PROD_1    | MCS_PROD_1 | 5       | NULL | 2296653 |   100.00 | Using index condition |+----+-------------+----------+------------+-------+---------------+------------+---------+------+---------+----------+-----------------------+1 row in set, 1 warning (0.00 sec)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>先来说一下这个 ORDER BY 执行过程：</p> <ol><li>初始化 SORT_BUFFER，放入 MCS_PROD_ID,MCS_CODE,MCS_NAME,UPDT_TIME 四个字段</li> <li>从索引 UPDT_TIME 找到满足条件的主键 ID，回表查询出四个字段值存入 SORT_BUFFER</li> <li>从索引处继续查询满足 UPDT_TIME 条件记录，继续执行步骤 2</li> <li>对 SORT_BUFFER 中的数据按照 UPDT_TIME 排序</li> <li>排序成功后取出符合 LIMIT 条件的记录返回客户端</li></ol> <p>按照 UPDT_TIME 排序可能在内存中完成，也可能需要使用外部排序，取决于排序所需的内存和参数 SORT_BUFFER_SIZE</p> <p><strong>SORT_BUFFER_SIZE 是 MySQL 为排序开辟的内存</strong>。如果排序数据量小于 SORT_BUFFER_SIZE，排序会在内存中完成。如果数据量过大，内存放不下，<strong>则会利用磁盘临时文件排序</strong></p> <blockquote><p>针对 SORT_BUFFER_SIZE 这个参数在网上查询到有用资料比较少，大家如果测试过程中存在问题，可以加微信一起沟通</p></blockquote> <h4 id="order-by-索引失效举例"><a href="#order-by-索引失效举例" class="header-anchor">#</a> ORDER BY 索引失效举例</h4> <p>OFFSET 100000 时，通过 key Extra 得知，没有使用磁盘临时文件排序，这个时候把 OFFSET 调整到 500000</p> <p><strong>凉凉夜色为你思念成河，化作春泥呵护着你...</strong> 一首凉凉送给写这个 SQL 的同学，发现了 Using filesort</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> MCS_PROD_ID<span class="token punctuation">,</span>MCS_CODE<span class="token punctuation">,</span>MCS_NAME<span class="token punctuation">,</span>UPDT_TIME <span class="token keyword">FROM</span> MCS_PROD <span class="token keyword">WHERE</span> <span class="token punctuation">(</span>UPDT_TIME <span class="token operator">&gt;=</span> <span class="token string">'1970-01-01 00:00:00.0'</span><span class="token punctuation">)</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> UPDT_TIME <span class="token keyword">LIMIT</span> <span class="token number">500000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----+-------------+----------+------------+------+---------------+------+---------+------+---------+----------+-----------------------------+| id | select_type | table    | partitions | type | possible_keys | key  | key_len | ref  | rows    | filtered | Extra                       |+----+-------------+----------+------------+------+---------------+------+---------+------+---------+----------+-----------------------------+|  1 | SIMPLE      | MCS_PROD | NULL       | ALL  | MCS_PROD_1    | NULL | NULL    | NULL | 4593306 |    50.00 | Using where; Using filesort |+----+-------------+----------+------------+------+---------------+------+---------+------+---------+----------+-----------------------------+1 row in set, 1 warning (0.00 sec)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Using filesort 表示在索引之外，<strong>需要额外进行外部的排序动作</strong>，性能必将受到严重影响</p> <p>所以我们应该 <strong>结合相对应的业务逻辑避免常规 LIMIT OFFSET</strong>，采用 <strong># 深分页优化</strong> 章节进行修改对应业务</p> <h2 id="结言"><a href="#结言" class="header-anchor">#</a> 结言</h2> <p><strong>最后有一点需要声明下，MySQL 本身并不适合单表大数据量业务</strong></p> <p>因为 MySQL 应用在企业级项目时，针对库表查询并非简单的条件，可能会有更复杂的联合查询，亦或者是大数据量时存在频繁新增或更新操作，维护索引或者数据 ACID 特性上必然存在性能牺牲</p> <p>如果设计初期能够预料到库表的数据增长，理应构思合理的重构优化方式，比如 ES 配合查询、分库分表、TiDB 等解决方式</p> <br> <p><strong>参考资料：</strong></p> <ol><li>《高性能 MySQL 第三版》</li> <li>《MySQL 实战 45 讲》</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9f6db045.js" defer></script><script src="/assets/js/2.ad010850.js" defer></script><script src="/assets/js/12.ad56d1ad.js" defer></script>
  </body>
</html>
