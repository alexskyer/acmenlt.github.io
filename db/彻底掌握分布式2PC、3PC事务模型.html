<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前言 | 龙台技术笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/images/book.png">
    <link rel="manifest" href="/images/book.png">
    <link rel="apple-touch-icon" href="/images/book.png">
    <meta name="description" content="技术人写的技术笔记（工作总结）">
    <meta http-quiv="pragma" cotent="no-cache">
    <meta http-quiv="pragma" cotent="no-cache,must-revalidate">
    <meta http-quiv="expires" cotent="0">
    
    <link rel="preload" href="/assets/css/0.styles.56f8f03c.css" as="style"><link rel="preload" href="/assets/js/app.9f6db045.js" as="script"><link rel="preload" href="/assets/js/2.ad010850.js" as="script"><link rel="preload" href="/assets/js/15.4bd8d806.js" as="script"><link rel="prefetch" href="/assets/js/10.cbffc92a.js"><link rel="prefetch" href="/assets/js/11.05ca654e.js"><link rel="prefetch" href="/assets/js/12.ad56d1ad.js"><link rel="prefetch" href="/assets/js/13.cbb68b5f.js"><link rel="prefetch" href="/assets/js/14.deb3efeb.js"><link rel="prefetch" href="/assets/js/16.18544ac8.js"><link rel="prefetch" href="/assets/js/17.3d970734.js"><link rel="prefetch" href="/assets/js/18.24bdf351.js"><link rel="prefetch" href="/assets/js/19.20ee8468.js"><link rel="prefetch" href="/assets/js/20.76cc2f2f.js"><link rel="prefetch" href="/assets/js/21.a060d59a.js"><link rel="prefetch" href="/assets/js/22.8dd2c3cb.js"><link rel="prefetch" href="/assets/js/23.38503d1a.js"><link rel="prefetch" href="/assets/js/24.b5bab63e.js"><link rel="prefetch" href="/assets/js/25.f541c5de.js"><link rel="prefetch" href="/assets/js/26.ee0820ec.js"><link rel="prefetch" href="/assets/js/27.8e2f5fd3.js"><link rel="prefetch" href="/assets/js/28.b05c6b48.js"><link rel="prefetch" href="/assets/js/29.19cdc57c.js"><link rel="prefetch" href="/assets/js/3.d533eea8.js"><link rel="prefetch" href="/assets/js/30.98878ec6.js"><link rel="prefetch" href="/assets/js/31.572b5ab4.js"><link rel="prefetch" href="/assets/js/32.bce65027.js"><link rel="prefetch" href="/assets/js/33.37e89393.js"><link rel="prefetch" href="/assets/js/34.ba1a6fba.js"><link rel="prefetch" href="/assets/js/35.c7dd14b8.js"><link rel="prefetch" href="/assets/js/36.91b56d4a.js"><link rel="prefetch" href="/assets/js/37.818f9351.js"><link rel="prefetch" href="/assets/js/38.f7f3e6b0.js"><link rel="prefetch" href="/assets/js/39.4a1489dc.js"><link rel="prefetch" href="/assets/js/4.d52d5841.js"><link rel="prefetch" href="/assets/js/40.175dfc07.js"><link rel="prefetch" href="/assets/js/41.d75e30b9.js"><link rel="prefetch" href="/assets/js/42.dcfe80e6.js"><link rel="prefetch" href="/assets/js/43.4669e03d.js"><link rel="prefetch" href="/assets/js/44.5b6aa46b.js"><link rel="prefetch" href="/assets/js/5.8c9ed1e9.js"><link rel="prefetch" href="/assets/js/6.256d2fbb.js"><link rel="prefetch" href="/assets/js/7.26cc56f0.js"><link rel="prefetch" href="/assets/js/8.d0a0d91a.js"><link rel="prefetch" href="/assets/js/9.272d66c4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.56f8f03c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">龙台技术笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/db/" class="nav-link router-link-active">
  数据库
</a></div><div class="nav-item"><a href="/thread/" class="nav-link">
  并发编程
</a></div><div class="nav-item"><a href="/frame/" class="nav-link">
  框架知识
</a></div><div class="nav-item"><a href="/design/" class="nav-link">
  代码设计
</a></div><div class="nav-item"><a href="/bug/" class="nav-link">
  BUG 专栏
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title">其它</span> <span class="arrow down"></span></button> <button type="button" aria-label="其它" class="mobile-dropdown-title"><span class="title">其它</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  动态线程池
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/acmenlt/House-Notes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  买房实践
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/db/" class="nav-link router-link-active">
  数据库
</a></div><div class="nav-item"><a href="/thread/" class="nav-link">
  并发编程
</a></div><div class="nav-item"><a href="/frame/" class="nav-link">
  框架知识
</a></div><div class="nav-item"><a href="/design/" class="nav-link">
  代码设计
</a></div><div class="nav-item"><a href="/bug/" class="nav-link">
  BUG 专栏
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title">其它</span> <span class="arrow down"></span></button> <button type="button" aria-label="其它" class="mobile-dropdown-title"><span class="title">其它</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  动态线程池
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/acmenlt/House-Notes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  买房实践
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/acmenlt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前言</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/db/%E5%BD%BB%E5%BA%95%E6%8E%8C%E6%8F%A1%E5%88%86%E5%B8%83%E5%BC%8F2PC%E3%80%813PC%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%9E%8B.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/db/%E5%BD%BB%E5%BA%95%E6%8E%8C%E6%8F%A1%E5%88%86%E5%B8%83%E5%BC%8F2PC%E3%80%813PC%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%9E%8B.html#什么是事务" class="sidebar-link">什么是事务</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/db/%E5%BD%BB%E5%BA%95%E6%8E%8C%E6%8F%A1%E5%88%86%E5%B8%83%E5%BC%8F2PC%E3%80%813PC%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%9E%8B.html#什么是分布式事务" class="sidebar-link">什么是分布式事务</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/db/%E5%BD%BB%E5%BA%95%E6%8E%8C%E6%8F%A1%E5%88%86%E5%B8%83%E5%BC%8F2PC%E3%80%813PC%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%9E%8B.html#dtp-模型和-xa-规范" class="sidebar-link">DTP 模型和 XA 规范</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/db/%E5%BD%BB%E5%BA%95%E6%8E%8C%E6%8F%A1%E5%88%86%E5%B8%83%E5%BC%8F2PC%E3%80%813PC%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%9E%8B.html#xa-规范" class="sidebar-link">XA 规范</a></li></ul></li><li><a href="/db/%E5%BD%BB%E5%BA%95%E6%8E%8C%E6%8F%A1%E5%88%86%E5%B8%83%E5%BC%8F2PC%E3%80%813PC%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%9E%8B.html#_2pc-一致性算法" class="sidebar-link">2PC 一致性算法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/db/%E5%BD%BB%E5%BA%95%E6%8E%8C%E6%8F%A1%E5%88%86%E5%B8%83%E5%BC%8F2PC%E3%80%813PC%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%9E%8B.html#_2pc-准备阶段" class="sidebar-link">2PC-准备阶段</a></li><li class="sidebar-sub-header"><a href="/db/%E5%BD%BB%E5%BA%95%E6%8E%8C%E6%8F%A1%E5%88%86%E5%B8%83%E5%BC%8F2PC%E3%80%813PC%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%9E%8B.html#_2pc-提交阶段" class="sidebar-link">2PC-提交阶段</a></li><li class="sidebar-sub-header"><a href="/db/%E5%BD%BB%E5%BA%95%E6%8E%8C%E6%8F%A1%E5%88%86%E5%B8%83%E5%BC%8F2PC%E3%80%813PC%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%9E%8B.html#_2pc-优缺点" class="sidebar-link">2PC 优缺点</a></li></ul></li><li><a href="/db/%E5%BD%BB%E5%BA%95%E6%8E%8C%E6%8F%A1%E5%88%86%E5%B8%83%E5%BC%8F2PC%E3%80%813PC%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%9E%8B.html#_3pc-一致性算法" class="sidebar-link">3PC 一致性算法</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/db/%E5%BD%BB%E5%BA%95%E6%8E%8C%E6%8F%A1%E5%88%86%E5%B8%83%E5%BC%8F2PC%E3%80%813PC%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%9E%8B.html#jdbc-操作-mysql-xa-事务" class="sidebar-link">JDBC 操作 MySQL XA 事务</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/db/%E5%BD%BB%E5%BA%95%E6%8E%8C%E6%8F%A1%E5%88%86%E5%B8%83%E5%BC%8F2PC%E3%80%813PC%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%9E%8B.html#结言" class="sidebar-link">结言</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>工作中使用最多的是本地事务，但是在对单一项目拆分为 SOA、微服务之后，就会牵扯出分布式事务场景</p> <p>文章以分布式事务为主线展开说明，并且针对 2PC、3PC 算法进行详细的讲解，最后通过一个 Demo 来更深入掌握分布式事务，文章目录结构如下</p> <blockquote><ul><li>什么是事务</li> <li>什么是分布式事务</li> <li>DTP 模型和 XA 规范
<ul><li>什么是 DTP 模型</li> <li>什么是 XA 规范</li></ul></li> <li>2PC 一致性算法
<ul><li>2PC-准备阶段</li> <li>2PC-提交阶段</li> <li>2PC 算法优缺点</li></ul></li> <li>3PC 一致性算法</li> <li>JDBC 操作 MySQL XA 事务</li> <li>结言</li></ul></blockquote> <h2 id="什么是事务"><a href="#什么是事务" class="header-anchor">#</a> 什么是事务</h2> <p>事务是<code>数据库操作的最小工作单元</code>，一组不可再分割的操作集合，是作为单个逻辑工作单元执行的一系列操作。这些操作作为一个整体一起向系统提交，<code>要么都执行、要么都不执行</code></p> <p>事务具有四个特征，分别是<code>原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）和持久性（Durability）</code>，简称为事务的 ACID 特性</p> <p><strong>如何保证事务的 ACID 特性？</strong></p> <ul><li><p>原子性（Atomicity）：事务内 SQL 要么同时成功要么同时失败，基于撤销日志（undo 日志）实现</p></li> <li><p>一致性（Consistency）：系统从一个正确态转移到另一个正确态，由应用通过 AID 来保证，可以说是事务的核心特性</p></li> <li><p>隔离性（Isolation）：控制事务并发执行时数据的可见性，基于锁和多版本并发控制（mvcc）实现</p></li> <li><p>持久性（Durability）：提交后一定存储成功不会丢失，基于重做日志（redo log）实现</p></li></ul> <p>文章主要是介绍分布式事务 <code>2PC 和 3PC</code>，关于 <code>redo、undo 日志、mvcc、锁</code>这块的内容后续再详细介绍</p> <p>在早些时候，我们应用程序还是单体项目，所以操作的都是单一数据库，这种情况下我们称之为<code>本地事务</code>。本地事务的 ACID 一般都是由数据库层面支持的，比如我们工作中常用的 MySQL 数据库</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210304162720353.png" alt=""></p> <p>平常我们在操作 MySQL 客户端时，MySQL 会隐式对事务做自动提交，所以日常工作不会涉及手动书写事务的创建、提交、回滚等操作。如果想要试验锁、MVCC等特性，可以创建多个会话，通过<code>begin、commit、rollback</code>等命令来试验下不同事务之间的数据，看执行结果和自己所想是否一致</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210304173646000.png" alt=""></p> <p>我们平常开发项目代码时使用的是 Spring 封装好的事务，所以也不会手动编写对数据库事务的提交、回滚等方法（个别情况除外）。这里使用原生 JDBC 写一个示例代码，帮助大家理解如何通过事务保证 ACID 四大特性</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span> <span class="token comment">// 获取数据库连接</span>
conn<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 开启事务</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
   <span class="token comment">// ...执行增删改查sql</span>
   conn<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 提交事务</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  conn<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 事务回滚</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
   conn<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭链接</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>设想一下，每次进行数据库操作，都要写重复的创建事务、提交、回滚等方法是不是挺痛苦的，那 Spring 如何自动帮助我们管理事务的呢？Spring 项目中我们一般使用两种方式来进行事务的管理，<code>编程式事务和声明式事务</code></p> <p>项目中使用 Spring 管理事务，要么在接口方法上添加注解 <code>@Transactional</code>，要么使用 AOP 配置切面事务。其实这两种方式大同小异，只不过 <code>@Transactional</code> 的粒度更细一些，实现原理上都是依赖 AOP，举例说明下</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionalService</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Transactional</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 业务操作</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>TransactionalService</code> 会被 Spring 创建一个代理对象放入到容器中，创建后的代理对象相当于下述类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionalServiceProxy</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token class-name">TransactionalService</span> transactionalService<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token class-name">TransactionalServiceProxy</span><span class="token punctuation">(</span><span class="token class-name">TransactionalService</span> transactionalService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>transactionalService <span class="token operator">=</span> transactionalService<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token comment">// 开启事务操作</span>
          transactionalService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 出现异常则进行回滚</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 提交事务</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>示例代码看着简洁明了，但是真正的代码生成代码对比要复杂很多。关于事务管理器，Spring 提供了接口 <code>PlatformTransactionManager</code>，其内部包含两个重要实现类</p> <ul><li><p><code>DataSourceTransactionManager</code>：支持本地事务，内部通过<code>java.sql.Connection</code>来开启、提交和回滚事务</p></li> <li><p><code>JtaTransactionManager</code>：用于支持分布式事务，其实现了 JTA 规范，使用 XA 协议进行两阶段提交</p></li></ul> <p>通过这两个实现类得知，平常我们使用的<code>编程式事务和声明式事务</code>依赖于本地事务管理实现，<code>Spring 同时也支持分布式事务</code>，关于 JTA 分布式事务的支持网上资料挺多的，就不在这里赘述了</p> <h2 id="什么是分布式事务"><a href="#什么是分布式事务" class="header-anchor">#</a> 什么是分布式事务</h2> <p>日常业务代码中的本地事务我们一直都在用，理解起来并不困难。但是随着<code>服务化（SOA）、微服务</code>的流行，平常我们的单一业务系统被拆分成为了多个系统，为了迎合业务系统的变更，数据库也结合业务进行了拆分</p> <p>比如以学校管理系统举例说明，可能就会拆分为学生服务、课程服务、老师服务等，数据库也拆分为多个库。当这种情况，把不同的服务部署到服务器，就会有可能面临下述的服务调用</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210305105346584.png" alt=""></p> <p>ServiceA 服务需要操作数据库执行本地事务，同时需要调用 ServiceB 和 ServiceC 服务发起事务调用，<code>如何保证三个服务的事务要么一起成功或者一起失败</code>，如何保证用户发起请求的事务 ACID 特性呢？无疑这就是分布式事务场景，<code>三个服务的单一本地事务都无法保证整个请求的事务</code></p> <p>分布式事务场景有很多种解决方案，以不同分类来看，<code>强一致性解决方案、最终一致性解决方案</code>，细分其中的方案包括<code>2PC、3PC、TCC、可靠消息...</code></p> <p>业界中使用较多的像阿里的 <code>RocketMQ 事务消息</code>、<code>Seata XA模式</code>、<code>可靠消息模型</code>这几种解决方案。不过，分布式事务无一例外都是会直接或间接操作多个数据库，<code>而且使用了分布式事务同时也会带来新的挑战，那就是性能问题</code>。如果为了保证强一致性分布式事务亦或者补偿方案的最终一致性，导致了性能的下降，对于正常业务而言，无疑是得不偿失的</p> <h2 id="dtp-模型和-xa-规范"><a href="#dtp-模型和-xa-规范" class="header-anchor">#</a> DTP 模型和 XA 规范</h2> <p>X/Open 组织定义了分布式事务的模型（DTP）和 分布式事务协议（XA），DTP 由以下几个模型元素组成</p> <ul><li><code>AP（Application 应用程序）</code>：用于定义事务边界(即定义事务的开始和结束)，并且在事务边界内对资源进行操作</li> <li><code>TM（Transaction Manager 事务管理器）</code>：负责分配事务唯一标识，监控事务的执行进度，并负责事务的提交、回滚等</li> <li><code>RM（Resource Manager 资源管理器）</code>：如数据库、文件系统等，并提供访问资源的方式</li> <li>CRM（Communication Resource Manager 通信资源管理器）：控制一个TM域(TM domain)内或者跨TM域的分布式应用之间的通信</li> <li>CP（Communication Protocol 通信协议）：提供CRM提供的分布式应用节点之间的底层通信服务</li></ul> <p>在 DTP 分布式事务模型中，基本组成需要涵盖 <strong>AP、TM、RMS</strong>（不需要 CRM、CP 也是可以的），如下图所示</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210306135942749.png" alt=""></p> <h3 id="xa-规范"><a href="#xa-规范" class="header-anchor">#</a> XA 规范</h3> <p>XA 规范最重要的作用就是定义 RM（资源管理器）与 TM（事务管理器）之间的交互接口。另外，XA 规范除了定义 2PC 之间的交互接口外，同时对 2PC 进行了优化</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210306135753269.png" alt=""></p> <p><strong><font color="#FF0000">梳理下 DTP、XA、2PC 之间的关系</font></strong></p> <p><code>DTP 规定了分布式事务中的角色模型</code>，并在其中指定了全局事务的控制需要使用 2PC 协议来保证数据的一致性</p> <p>2PC 是 Two-Phase Commit 的缩写，即二阶段提交，是计算机网络尤其是数据库领域内，为了保证分布式系统架构下所有节点在进行事务处理过程中能够<code>保证原子性和一致性</code>而设计的一种算法。同时，2PC 也被认为是一种一致性协议，<code>用来保证分布式系统数据的一致性</code></p> <p>XA 规范是 X/Open 组织提出的分布式事务处理规范，<code>XA 规范定义了 2PC（两阶段提交协议）中需要用到的接口</code>，也就是上图中 RM 和 TM 之间的交互。2PC 和 XA 两者最容易混淆，可以这么理解，DTP 模型定义 TM 和 RM 之间通讯的接口规范叫 XA，然后 <strong>关系数据库（比如MySQL）基于 X/Open 提出的的 XA 规范（核心依赖于 2PC 算法）被称为 XA 方案</strong></p> <h2 id="_2pc-一致性算法"><a href="#_2pc-一致性算法" class="header-anchor">#</a> 2PC 一致性算法</h2> <p>当应用程序（AP）发起一个事务操作需要<code>跨越多个分布式节点</code>的时候，每一个<code>分布式节点（RM）</code>知道自己进行事务操作的结果是成功或是失败，但是却<code>不能获取到其它分布式节点的操作结果</code>。为了保证事务处理的 ACID 特性，就需要引入称为<code>&quot;协调者&quot;的组件（TM）</code>来进行统一调度分布式的执行逻辑</p> <p><code>协调者负责调度参与整体事务的分布式节点的行为</code>，并最终决定这些分布式节点要把事务进行提交还是回滚。所以，基于这种思想下，衍生出了<code>二阶段提交和三阶段提交</code>两种分布式一致性算法协议。二阶段指的是<strong>准备阶段和提交阶段</strong>，下面我们先看准备阶段都做了什么事情</p> <h3 id="_2pc-准备阶段"><a href="#_2pc-准备阶段" class="header-anchor">#</a> 2PC-准备阶段</h3> <p>二阶段提交中第一阶段也叫做<code>&quot;投票阶段&quot;</code>，即各参与者投票表明自身是否继续执行接下来的事务提交步骤</p> <ul><li><p><strong>事务询问</strong>：协调者向所有参与本次分布式事务的参与者发送事务内容，询问是否可以执行事务提交操作，然后开始等待各个参与者的响应</p></li> <li><p><strong>执行事务</strong>：参与者收到协调者的事务请求，执行对应的事务，并将内容写入 Undo 和 Redo 日志</p></li> <li><p><strong>返回响应</strong>：如果各个参与者执行了事务，那么反馈协调者 Yes 响应；如果各个参与者没有能够成功执行事务，那么就会返回协调者 No 响应</p></li></ul> <p>如果第一阶段全部参与者返回成功响应，那么进入事务提交步骤，反之本次分布式事务以失败返回。以 MySQL 数据库为例，在第一阶段，事务管理器（TM）向所有涉及到的数据库（RM）发出 <strong>prepare（准备提交）</strong> 请求，数据库收到请求后执行数据修改和日志记录处理，处理完成后把事务的状态修改为 &quot;可提交&quot;，最终将结果返回给事务处理器</p> <h3 id="_2pc-提交阶段"><a href="#_2pc-提交阶段" class="header-anchor">#</a> 2PC-提交阶段</h3> <p>提交阶段分为两个流程，一个是各参与者正常执行事务提交流程，并返回 Ack 响应，表示各参与者投票成功；一个是各参与者当中有执行失败返回 No 响应或超时情况，将触发全局回滚，表示分布式事务执行失败</p> <ul><li><p>执行事务提交</p></li> <li><p>中断事务</p></li></ul> <h4 id="执行事务提交"><a href="#执行事务提交" class="header-anchor">#</a> 执行事务提交</h4> <p>假设协调者从所有的参与者获得的反馈都是 Yes 响应，那么就会执行事务提交操作</p> <ul><li><p>事务提交：协调者向所有参与者节点发出 Commit 请求，各个参与者接收到 Commit 请求后，将本地事务进行提交操作，并在完成提交之后释放事务执行周期内占用的事务资源</p></li> <li><p>完成事务：各个参与者完成事务提交之后，向协调者发送 Ack 响应，协调者接收到响应后完成本次分布式事务</p></li></ul> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210306164157428.png" alt=""></p> <h4 id="中断事务"><a href="#中断事务" class="header-anchor">#</a> 中断事务</h4> <p>假设任意一个事务参与者节点向协调者反馈了 No 响应（<strong><font color="#FF0000">注意这里的 No 响应指的是第一阶段</font></strong>），或者在等待超时之后，协调者没有接到所有参与者的反馈响应，那么就会进行事务中断流程</p> <ul><li><p>事务回滚：协调者向所有参与者发出 Rollback 请求，参与者接收到回滚请求后，使用第一阶段写入的 undo log 执行事务的回滚，并在完成回滚事务之后释放占用的资源</p></li> <li><p>中断事务：参与者在完成事务回滚之后，向协调者发送 Ack 消息，协调者接收到事务参与者的 Ack 消息之后，完成事务中断</p></li></ul> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210306164501746.png" alt=""></p> <h3 id="_2pc-优缺点"><a href="#_2pc-优缺点" class="header-anchor">#</a> 2PC 优缺点</h3> <p>2PC 提交将事务的处理过程分为了投票和执行两个阶段，核心思想就是对每个事务都采用先尝试后提交的方式处理。2PC 优点显而易见，那就是 <strong>原理简单，实现方便</strong>。简单也意味着很多地方不能尽善尽美，这里梳理三个比较核心的缺陷</p> <ol><li><p>同步阻塞：无论是在第一阶段的过程中，还是在第二阶段，所有的<code>参与者资源和协调者资源都是被锁住的</code>，只有当所有节点准备完毕，事务协调者才会通知进行全局提交，参与者进行本地事务提交后才会释放资源。<code>这样的过程会比较漫长，对性能影响比较大</code></p></li> <li><p>单点故障：<code>如果协调者出现问题，那么整个二阶段提交流程将无法运转</code>。另外，如果协调者是在第二阶段出现了故障，那么其它参与者将会处于锁定事务资源的状态中</p></li> <li><p>数据不一致性：当协调者在第二阶段向所有参与者发送 Commit 请求后，发生了<code>局部网络异常或者协调者在尚未发送完 Commit 请求之前自身发生了崩溃</code>，导致只有部分参与者接收到 Commit 请求，那么<code>接收到的参与者就会进行提交事务</code>，进而形成了数据不一致性</p></li></ol> <p>由于 2PC 的简单方便，所以会产生上述的同步阻塞、单点故障、数据不一致等情况，所以在 2PC 的基础上做了改进，推行出了三阶段提交（3PC）</p> <blockquote><p>使用 2PC 存在诸多限制，首先就是数据库需要支持 XA 规范，而且性能与数据一致性数据均不友好，所以 Seata 中虽然支持 XA 模式，但是主推的还是 AT 模式</p></blockquote> <h2 id="_3pc-一致性算法"><a href="#_3pc-一致性算法" class="header-anchor">#</a> 3PC 一致性算法</h2> <p>三阶段提交（3PC）是二阶段提交（2PC）的一个改良版本，引入了两个新的特性</p> <ol><li><p><code>协调者和参与者均引入超时机制</code>，通过超时机制来解决 2PC 的同步阻塞问题，避免事务资源被永久锁定</p></li> <li><p>把二阶段演变为三阶段，<code>二阶段提交协议中的第一阶段&quot;准备阶段&quot;一分为二</code>，形成了新的 CanCommit、PreCommit、do Commit 三个阶段组成事务处理协议</p></li></ol> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210306182315718.png" alt=""></p> <p>这里将不再赘述 3PC 的详细提交过程，3PC 相比较于 2PC 最大的优点就是<code>降低了参与者的阻塞范围</code>，并且能够在协调者出现单点故障后继续达成一致</p> <p>虽然通过超时机制解决了资源永久阻塞的问题，但是 3PC 依然存在数据不一致的问题。<code>当参与者接收到 PreCommit 消息后</code>，如果网络出现分区，此时协调者与参与者无法进行正常通信，这种情况下，<code>参与者依然会进行事务的提交</code></p> <p>通过了解 2PC 和 3PC 之后，我们可以知道这两者都无法彻底解决分布式下的数据一致性</p> <h2 id="jdbc-操作-mysql-xa-事务"><a href="#jdbc-操作-mysql-xa-事务" class="header-anchor">#</a> JDBC 操作 MySQL XA 事务</h2> <p>MySQL 从 5.0.3 开始支持 XA 分布式事务，且只有 InnoDB 存储引擎支持。MySQL Connector/J 从5.0.0 版本之后开始直接提供对 XA 的支持</p> <p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20210306183250966.png" alt=""></p> <p>在 DTP 模型中，MySQL 属于 RM 资源管理器，所以这里就不再演示 MySQL 支持 XA 事务的语句，因为它执行的只是自己单一事务分支，我们通过 <code>JDBC 来演示如何通过 TM 来控制多个 RM 完成 2PC 分布式事务</code></p> <p>这里先来说明需要引入 GAV 的 Maven 版本，因为高版本 8.x 移除了对 XA 分布式事务的支持（<em>可能也是觉得没人会用吧</em>）</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.38<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这里为了保证在公众号阅读的舒适性，通过 IDEA 将多行代码合并为一行了，如果小伙伴需要粘贴到 IDEA 中，格式化一下就好了</p> <p>因为 XA 协议的基础是 2PC 一致性算法，所以小伙伴在看代码时可以对照上面文章讲的 DTP 模型和 2PC 来进行理解以及模拟错误和执行结果</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>jdbc2<span class="token punctuation">.</span>optional<span class="token punctuation">.</span></span><span class="token class-name">MysqlXAConnection</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>jdbc2<span class="token punctuation">.</span>optional<span class="token punctuation">.</span></span><span class="token class-name">MysqlXid</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">XAConnection</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>xa<span class="token punctuation">.</span></span><span class="token class-name">XAException</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>xa<span class="token punctuation">.</span></span><span class="token class-name">XAResource</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>xa<span class="token punctuation">.</span></span><span class="token class-name">Xid</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MysqlXAConnectionTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token comment">// true 表示打印 XA 语句, 用于调试</span>
        <span class="token keyword">boolean</span> logXaCommands <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// 获得资源管理器操作接口实例 RM1</span>
        <span class="token class-name">Connection</span> conn1 <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">&quot;jdbc:mysql://localhost:3306/test&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">XAConnection</span> xaConn1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MysqlXAConnection</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>Connection</span><span class="token punctuation">)</span> conn1<span class="token punctuation">,</span> logXaCommands<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">XAResource</span> rm1 <span class="token operator">=</span> xaConn1<span class="token punctuation">.</span><span class="token function">getXAResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获得资源管理器操作接口实例 RM2</span>
        <span class="token class-name">Connection</span> conn2 <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">&quot;jdbc:mysql://localhost:3306/test&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">XAConnection</span> xaConn2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MysqlXAConnection</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>Connection</span><span class="token punctuation">)</span> conn2<span class="token punctuation">,</span> logXaCommands<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">XAResource</span> rm2 <span class="token operator">=</span> xaConn2<span class="token punctuation">.</span><span class="token function">getXAResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// AP（应用程序）请求 TM（事务管理器） 执行一个分布式事务, TM 生成全局事务 ID</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gtrid <span class="token operator">=</span> <span class="token string">&quot;distributed_transaction_id_1&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> formatId <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// ============== 分别执行 RM1 和 RM2 上的事务分支 ====================</span>
            <span class="token comment">// TM 生成 RM1 上的事务分支 ID</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bqual1 <span class="token operator">=</span> <span class="token string">&quot;transaction_001&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Xid</span> xid1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MysqlXid</span><span class="token punctuation">(</span>gtrid<span class="token punctuation">,</span> bqual1<span class="token punctuation">,</span> formatId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 执行 RM1 上的事务分支</span>
            rm1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>xid1<span class="token punctuation">,</span> <span class="token class-name">XAResource</span><span class="token punctuation">.</span>TMNOFLAGS<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">PreparedStatement</span> ps1 <span class="token operator">=</span> conn1<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token string">&quot;INSERT into user(name) VALUES ('jack')&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ps1<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>rm1<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>xid1<span class="token punctuation">,</span> <span class="token class-name">XAResource</span><span class="token punctuation">.</span>TMSUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// TM 生成 RM2 上的事务分支 ID</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bqual2 <span class="token operator">=</span> <span class="token string">&quot;transaction_002&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Xid</span> xid2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MysqlXid</span><span class="token punctuation">(</span>gtrid<span class="token punctuation">,</span> bqual2<span class="token punctuation">,</span> formatId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 执行 RM2 上的事务分支</span>
            rm2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>xid2<span class="token punctuation">,</span> <span class="token class-name">XAResource</span><span class="token punctuation">.</span>TMNOFLAGS<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">PreparedStatement</span> ps2 <span class="token operator">=</span> conn2<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token string">&quot;INSERT into user(name) VALUES ('rose')&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ps2<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>rm2<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>xid2<span class="token punctuation">,</span> <span class="token class-name">XAResource</span><span class="token punctuation">.</span>TMSUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// =================== 两阶段提交 ================================</span>
            <span class="token comment">// phase1: 询问所有的RM 准备提交事务分支</span>
            <span class="token keyword">int</span> rm1_prepare <span class="token operator">=</span> rm1<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>xid1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> rm2_prepare <span class="token operator">=</span> rm2<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>xid2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// phase2: 提交所有事务分支</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rm1_prepare <span class="token operator">==</span> <span class="token class-name">XAResource</span><span class="token punctuation">.</span>XA_OK <span class="token operator">&amp;&amp;</span> rm2_prepare <span class="token operator">==</span> <span class="token class-name">XAResource</span><span class="token punctuation">.</span>XA_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 所有事务分支都 prepare 成功, 提交所有事务分支</span>
                rm1<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>xid1<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>rm2<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>xid2<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果有事务分支没有成功, 则回滚</span>
                rm1<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span>xid1<span class="token punctuation">)</span><span class="token punctuation">;</span>rm1<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span>xid2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">XAException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h2 id="结言"><a href="#结言" class="header-anchor">#</a> 结言</h2> <p>本文通过图文并茂的方式讲解了如何保证本地事务的四大特性，分布式事务的产出背景，以及 2PC、3PC 为何不能解决分布式情况下的数据一致性，最后通过 JDBC 演示了 2PC 的执行流程。相信大家看过后也对分布式事务有了较深的印象，同时对 DTP、XA、2PC 这几种比较容易混淆的概念有了清楚的认识</p> <p>这是《分布式事务》专栏的第一章开篇，后面陆续完成通过消息中间件、可靠消息模型、Seata XA模型完成分布式事务的文章，并对不同的实现方式进行总结利弊，挑选出合适场景使用不同的分布式事务解决方案</p> <p>作者认为最好的学习方式那就是实战，如果没有接触过分布式事务的小伙伴，可以通过自己正在写的项目，模拟出分布式事务的业务场景，加深印象的同时也能够更好理解分布式事务解决方案相关设计思路</p> <p><strong>创作不易，文章看到这里如果有所帮助，可以点个关注支持一下，祝好。我们下期见</strong></p> <br> <p><strong>站在巨人的肩膀</strong></p> <ul><li><p>《从Paxos到Zookeeper分布式一致性原理与实践》</p></li> <li><p>《田守枝Java技术博客》</p></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9f6db045.js" defer></script><script src="/assets/js/2.ad010850.js" defer></script><script src="/assets/js/15.4bd8d806.js" defer></script>
  </body>
</html>
